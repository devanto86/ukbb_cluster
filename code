library(tidyverse); library(broom); library(survival); library(knitr); library(ukbtools)

# IMPORT UKBB DATA with ukbtools in df
df <- # select variables of interest
df %>% select(eid, starts_with("age_when"), starts_with("sex_f31"), starts_with("body_mass_index_bmi_f21001"),
                   starts_with("date_of_attending_"), starts_with("waist_circumference"), starts_with("hip_circumference"),
                   starts_with("date_lost_to_followup_f191"), ethnic_background_f21000_0_0, 
                   uk_biobank_assessment_centre_f54_0_0, 
                   starts_with("noncancer_illness_code_selfreported_f20002_0"),
                   starts_with("cancer_code_selfreported_f20001_0_"),
                   starts_with("type_of_cancer_icd10_f40006_"),
                   starts_with("date_of_cancer_diagnosis_f40005_"),
                   starts_with("interpolated_age_of_participant_when_noncancer_illness_first_diagnosed_f20009_0_"),
                   starts_with("date_of_death_f40000_0_0"),
                   starts_with("underlying_primary_cause_of_death_icd10_f40001_0"),
                   starts_with("contributory_secondary_ca_f40002_0_"))

# COMORBIDITIES self reported ####
df.comorb <- 
  df %>% select(eid, starts_with("noncancer_ill")) %>% 
  pivot_longer(cols=c(starts_with("noncancer_ill")), names_to=c(".value", "ill.index"), names_sep = "_0_", values_drop_na = TRUE) %>% 
  mutate(diab.sr= noncancer_illness_code_selfreported_f20002 %in% c(1220, 1223),
         ipert= noncancer_illness_code_selfreported_f20002 %in% c(1065, 1072), 
         dyslip= noncancer_illness_code_selfreported_f20002 %in% c(1473),
         chrlivdis= noncancer_illness_code_selfreported_f20002 %in% c(1136, 1141, 1155, 1156, 1157, 1158, 1159, 1408, 1506, 1507, 1578, 1579, 1580, 1581, 1582, 1604, 1496, 1475), # includes hepatitis, cholangitis and cirrhosis
         cvd= noncancer_illness_code_selfreported_f20002 %in% c(1074, 1075, 1081, 1082, 1583)) %>%
  select(-ill.index, -noncancer_illness_code_selfreported_f20002) %>%  
  group_by(eid) %>% dplyr::summarise(across(everything(), ~as.numeric(sum(.x)>0)))

df <- df %>% left_join(df.comorb, by="eid") 
df <- df %>% mutate(diab.sr=ifelse(is.na(diab.sr), 0, diab.sr), ipert=ifelse(is.na(ipert), 0, ipert), dyslip =ifelse(is.na(dyslip), 0, dyslip), chrlivdis=ifelse(is.na(chrlivdis), 0, chrlivdis), cvd=ifelse(is.na(cvd), 0, cvd))
rm(list = c("df.comorb"))

# IMPORT HESIN DATA on hospitalizations
# updated at Jul 1st 2022
hesin_diag <- hesin_diag %>% select(-diag_icd9, -diag_icd9_nb, -diag_icd10_nb)
hesin_diag <- hesin_diag %>% left_join(hesin, by=c("eid", "ins_index")) %>% #use either epistart or admidate
  mutate(epistart=as.Date(case_when(epistart==""~admidate, TRUE~epistart), format="%d/%m/%Y"))
rm(list = c("hesin"))


hesin_diag <- hesin_diag %>% 
  mutate(
    cvd.icd= diag_icd10 %in% c("I200", "I20" ,"I201","I208","I209","I21","I210","I211","I212","I213","I214","I219","I21X","I22","I220","I221","I228","I229","I23","I230","I231","I232","I233","I234","I235","I236","I238","I24","I240","I241","I248","I249","I25","I250","I251","I252","I253","I254","I255","I256","I258","I259","I60","I600","I601","I602","I603","I604","I605","I606","I607","I608","I609","I61","I610","I611","I612","I613","I614","I615","I616","I618","I619","I62","I620","I621","I629","I63","I630","I631","I632","I633","I634","I635","I636","I638","I639","I64","I69","I690","I691","I692","I693","I694","I698","G45","G450","G451","G452","G453","G454","G458","G459"),
    date_cvd.icd= ifelse(cvd.icd==TRUE, epistart, NA),
    diab.inc= diag_icd10 %in% c("E110", "E111", "E112", "E113", "E114", "E115", "E116", "E117", "E118", "E119", "E140", "E141", "E142", "E143", "E144", "E145", "E146", "E147", "E148", "E149"),
    date_diab.inc= ifelse(diab.inc==TRUE, epistart, NA),
    cld.inc= diag_icd10 %in% c("C22" ,"C220", "I850", "I859", "K700", "K701", "K702", "K703", "K704", "K709", "K721", "K729", "K730", "K731", "K732", "K738", "K739", "K740", "K741", "K742", "K746", "K760", "K766", "K767", "K768", "K769", "Z944"), #CLD: chronic liver disease
    date_cld.inc= ifelse(cld.inc==TRUE, epistart, NA),
    excl.chrlivdis= diag_icd10 %in% c("B18", "B180", "B181", "B182","B188", "B189", "B19", "B190", "B199", "C22", "C220", "E830", "E831", "E880", "I820", "I850", "I859",
                                      "K70", "K71", "K710", "K711", "K7110", "K7111", "K712", "K713", "K714", "K715", "K7150", "K7151", "K716", "K717", "K718", "K719",
                                      "K721", "K729", "K741", "K742", "K743", "K744", "K745", "K746", "K752", "K753", "K754", "K758" , "K759",
                                      "K765", "K766" ,"K767", "K768", "K769", "K83", "R18", "Z944"),
    date_excl.chrlivdis= ifelse(excl.chrlivdis==TRUE, epistart, NA),
    excl.chrlivdis.fu= diag_icd10 %in% c("B180", "B181", "B182","B188", "B189", "B190", "B199", "E830", "E831", "E880", "I820", "K71", "K710", "K711", "K7110", "K7111", "K712", "K713", "K714", "K715", "K7150", "K7151", "K716", "K717", "K718", "K719",
                                         "K743", "K744", "K745", "K752", "K753", "K754", "K758", "K759", "K765", "K83"),
    date_excl.chrlivdis.fu= ifelse(excl.chrlivdis.fu==TRUE, epistart, NA), 
    chronic.viral.hepatitis= diag_icd10 %in% c("B18", "B180", "B181", "B182","B188", "B189", "B19", "B190", "B199"),
    date_chronic.viral.hepatitis= ifelse(chronic.viral.hepatitis==TRUE, epistart, NA))

hesin_diag %>% names()

hesin_diag <- hesin_diag %>% 
  group_by(eid) %>% dplyr::summarise(
    cvd.icd=as.numeric(sum(cvd.icd)>0),
    diab.inc=as.numeric(sum(diab.inc)>0), 
    cld.inc=as.numeric(sum(cld.inc)>0), 
    excl.chrlivdis=as.numeric(sum(excl.chrlivdis)>0),
    excl.chrlivdis.fu=as.numeric(sum(excl.chrlivdis.fu)>0),
    chronic.viral.hepatitis=as.numeric(sum(chronic.viral.hepatitis)>0),
    date_cvd.icd= min(date_cvd.icd, na.rm = TRUE),
    date_diab.inc= min(date_diab.inc, na.rm = TRUE),
    date_cld.inc= min(date_cld.inc, na.rm = TRUE),
    date_excl.chrlivdis= min(date_excl.chrlivdis, na.rm = TRUE),
    date_excl.chrlivdis.fu=min(date_excl.chrlivdis.fu, na.rm = TRUE),
    date_chronic.viral.hepatitis= min(date_chronic.viral.hepatitis, na.rm = TRUE)) %>% 
  mutate_at(vars(starts_with("date_")), function(x){as.Date(ifelse(is.infinite(x), NA, x), origin = "1970-01-01")})

df <- df %>% left_join(hesin_diag, by="eid") %>% 
  mutate(cvd.icd=ifelse(is.na(cvd.icd), 0, cvd.icd),
         diab.inc=ifelse(is.na(diab.inc), 0, diab.inc),
         cld.inc=ifelse(is.na(cld.inc), 0, cld.inc),
         excl.chrlivdis=ifelse(is.na(excl.chrlivdis), 0, excl.chrlivdis), 
         excl.chrlivdis.fu=ifelse(is.na(excl.chrlivdis.fu), 0, excl.chrlivdis.fu),
         chronic.viral.hepatitis=ifelse(is.na(chronic.viral.hepatitis), 0, chronic.viral.hepatitis))
summary(df$ttcvd.icd <- as.numeric(difftime(df$date_cvd.icd, df$date_of_attending_assessment_centre_f53_0_0, units = "days")/365))
summary(df$ttdiab.inc <- as.numeric(difftime(df$date_diab.inc, df$date_of_attending_assessment_centre_f53_0_0, units = "days")/365))
summary(df$ttcld.inc <- as.numeric(difftime(df$date_cld.inc, df$date_of_attending_assessment_centre_f53_0_0, units = "days")/365))
summary(df$ttexcl.chrlivdis <- as.numeric(difftime(df$date_excl.chrlivdis, df$date_of_attending_assessment_centre_f53_0_0, units = "days")/365))
summary(df$ttexcl.chrlivdis.fu <- as.numeric(difftime(df$date_excl.chrlivdis.fu, df$date_of_attending_assessment_centre_f53_0_0, units = "days")/365))
summary(df$ttchronic.viral.hepatitis <- as.numeric(difftime(df$date_chronic.viral.hepatitis, df$date_of_attending_assessment_centre_f53_0_0, units = "days")/365))
rm(list = "hesin_diag")

# Import HESIN DATA ON DEATHS
death <- death %>% left_join(death_cause, by=c("eid", "ins_index")) %>% mutate(date_of_death=as.Date(date_of_death, format="%d/%m/%Y"))
death %>% names

death <- 
  death %>% 
  mutate(
    cvd.icd.deceased= cause_icd10 %in% c("I200", "I20" ,"I201","I208","I209","I21","I210","I211","I212","I213","I214","I219","I21X","I22","I220","I221","I228","I229","I23","I230","I231","I232","I233","I234","I235","I236","I238","I24","I240","I241","I248","I249","I25","I250","I251","I252","I253","I254","I255","I256","I258","I259","I60","I600","I601","I602","I603","I604","I605","I606","I607","I608","I609","I61","I610","I611","I612","I613","I614","I615","I616","I618","I619","I62","I620","I621","I629","I63","I630","I631","I632","I633","I634","I635","I636","I638","I639","I64","I69","I690","I691","I692","I693","I694","I698","G45","G450","G451","G452","G453","G454","G458","G459"),
    cld.icd.deceased= cause_icd10 %in% c("C22" ,"C220", "I850", "I859", "K700", "K701", "K702", "K703", "K704", "K709", "K721", "K729", "K730", "K731", "K732", "K738", "K739", "K740", "K741", "K742", "K746", "K760", "K766", "K767", "K768", "K769", "Z944")) %>% 
  group_by(eid) %>% dplyr::summarise(
    cvd.icd.deceased= as.numeric(sum(cvd.icd.deceased, na.rm = TRUE))>0, 
    cld.icd.deceased= as.numeric(sum(cld.icd.deceased, na.rm = TRUE))>0,
    date_of_death=min(date_of_death, na.rm = TRUE))
    
df <- df %>% left_join(death, by = "eid") %>% 
  mutate(cvd.icd.deceased=ifelse(is.na(cvd.icd.deceased), 0, cvd.icd.deceased),
         cld.icd.deceased=ifelse(is.na(cld.icd.deceased), 0, cld.icd.deceased))
df$deceased <- case_when(!is.na(df$date_of_death) ~  1, TRUE ~ 0)
df$ttdeath <- case_when(
  df$deceased==1 ~ as.numeric(difftime(df$date_of_death, df$date_of_attending_assessment_centre_f53_0_0, units = "days"))/365,
  !is.na(df$date_lost_to_followup_f191_0_0) ~ as.numeric(difftime(df$date_lost_to_followup_f191_0_0, df$date_of_attending_assessment_centre_f53_0_0, units = "days"))/365, 
  TRUE ~ as.numeric(difftime("2022-07-01", df$date_of_attending_assessment_centre_f53_0_0, units = "days"))/365)

# MEDICATIONS
library(readxl)
dfmed <- df %>% select(eid, starts_with("treatmentmedication_code_f20003_0"))
dfmed.l <- df %>% pivot_longer(cols = starts_with("treatmentmedication_code_f20003_0"), names_to = "index", values_to = "coding", values_drop_na = TRUE)
dfmed.l <- dfmed.l %>% 
  mutate(coding=as.numeric(coding)) %>% left_join(diab.drugs, by="coding") %>% 
  mutate(diab.drugs=!is.na(abbreviation), diab.drugs.su= abbreviation %in% c("SU"), diab.drugs.agi= abbreviation %in% c("AGI"), 
         diab.drugs.tzd= abbreviation %in% c("TZD", "TZG+BGD"), diab.drugs.bgd= abbreviation %in% c("BGD", "TZD+BGD"), 
         diab.drugs.ins= abbreviation %in% c("INS"), diab.drugs.gli= abbreviation %in% c("GLI")) %>% select(-abbreviation) %>% 
  left_join(lipid.drugs, by="coding") %>% 
  mutate(lipid.drugs=!is.na(class), lipid.drugs.statin= class %in% c("STATIN"), lipid.drugs.statin.idro= statin_type %in% c("HYDROPHILIC"),lipid.drugs.statin.lipo= statin_type %in% c("LIPOPHILIC"), lipid.drugs.eze= class %in% c("EZETIMIBE"), lipid.drugs.fib= class %in% c("FIBRATE"),
         lipid.drugs.nia= class %in% c("NIACIN DERIVATIVES"), lipid.drugs.ome= class %in% c("OMEGA-3")) %>% select(-class) %>% 
  left_join(ipert.drugs, by="coding") %>% 
  mutate(ipert.drugs=!is.na(abbreviation), ipert.drugs.antiald= abbreviation %in% c("AA", "AA+BB", "AA+DIU"), 
         ipert.drugs.acei= abbreviation %in% c("ACEI", "ACEI+CCB DHP", "ACEI+CCB NON DHP", "ACEI¨+DIU"),
         ipert.drugs.arb= abbreviation %in% c("ARB", "ARB+DIU"), ipert.drugs.bb= abbreviation %in% c("BB", "BB+CCB DHP", "BB+DIU", "AA+BB"),
         ipert.drugs.ccbdhp= abbreviation %in% c("CCB DHP", "ACEI+CCB DHP", "BB+CCB DHP"),
         ipert.drugs.ccbnndhp= abbreviation %in% c("CCB NON DHP", "ACEI+CCB NON DHP", "CCB NON DHP+DIU"),
         ipert.drugs.diu= abbreviation %in% c("DIU", "AA+DIU", "ACEI+DIU", "ARB+DIU", "BB+DIU", "CCB NON DHP+DIU"))
dfmed.l <- dfmed.l %>% 
  group_by(eid) %>% 
  dplyr::summarise(diab.drugs.n=sum(as.numeric(diab.drugs)), diab.drugs=as.numeric(sum(diab.drugs)>0), diab.drugs.su=as.numeric(sum(diab.drugs.su)>0),
            diab.drugs.agi=as.numeric(sum(diab.drugs.agi)>0), diab.drugs.tzd=as.numeric(sum(diab.drugs.tzd)>0), diab.drugs.bgd=as.numeric(sum(diab.drugs.bgd)>0),
            diab.drugs.ins=as.numeric(sum(diab.drugs.ins)>0), diab.drugs.gli=as.numeric(sum(diab.drugs.gli)>0),
            lipid.drugs.n=sum(as.numeric(lipid.drugs)), lipid.drugs=as.numeric(sum(lipid.drugs)>0), lipid.drugs.statin= as.numeric(sum(lipid.drugs.statin)>0), lipid.drugs.statin.idro= as.numeric(sum(lipid.drugs.statin.idro)>0), lipid.drugs.statin.lipo= as.numeric(sum(lipid.drugs.statin.lipo)>0),
            lipid.drugs.eze=as.numeric(sum(lipid.drugs.eze)>0), lipid.drugs.nia=as.numeric(sum(lipid.drugs.nia)>0), lipid.drugs.fib=as.numeric(sum(lipid.drugs.fib)>0), lipid.drugs.ome=as.numeric(sum(lipid.drugs.ome)>0),
            ipert.drugs.n=sum(as.numeric(ipert.drugs)), ipert.drugs= as.numeric(sum(ipert.drugs)>0), ipert.drugs.antiald= as.numeric(sum(ipert.drugs.antiald)>0), 
            ipert.drugs.acei=as.numeric(sum(ipert.drugs.acei)>0), ipert.drugs.bb=as.numeric(sum(ipert.drugs.bb)>0),
            ipert.drugs.arb= as.numeric(sum(ipert.drugs.arb)>0), ipert.drugs.ccbdhp=as.numeric(sum(ipert.drugs.ccbdhp)>0),
            ipert.drugs.ccbnndhp= as.numeric(sum(ipert.drugs.ccbnndhp)>0), ipert.drugs.diu= as.numeric(sum(ipert.drugs.diu)>0)) 
df <- df %>% left_join(dfmed.l %>% select(eid, diab.drugs, diab.drugs.n, diab.drugs.su, diab.drugs.agi, diab.drugs.gli, diab.drugs.tzd, diab.drugs.bgd, diab.drugs.ins,
                                            lipid.drugs, lipid.drugs.n, lipid.drugs.statin,lipid.drugs.statin.idro,lipid.drugs.statin.lipo, lipid.drugs.ome, lipid.drugs.fib, lipid.drugs.eze,
                                            ipert.drugs, ipert.drugs.n, ipert.drugs.antiald, ipert.drugs.acei, ipert.drugs.arb, ipert.drugs.ccbdhp,
                                            ipert.drugs.ccbnndhp, ipert.drugs.diu), by="eid") %>% 
  mutate_at(vars("diab.drugs", "diab.drugs.n", "diab.drugs.su", "diab.drugs.agi", "diab.drugs.gli", "diab.drugs.tzd", "diab.drugs.bgd", "diab.drugs.ins", "lipid.drugs", "lipid.drugs.n", "lipid.drugs.statin", "lipid.drugs.statin.idro", "lipid.drugs.statin.lipo", "lipid.drugs.ome", "lipid.drugs.fib", "lipid.drugs.eze",
                 "ipert.drugs", "ipert.drugs.n", "ipert.drugs.antiald", "ipert.drugs.acei", "ipert.drugs.arb", "ipert.drugs.ccbdhp", "ipert.drugs.ccbnndhp", "ipert.drugs.diu"),
            function(x) ifelse(is.na(x), 0, x))

df$ipert <- ifelse(df$ipert==1, 1, ifelse(df$ipert.drugs==1, 1, 0))
table(df$ipert, useNA = "ifany")
df$dyslip <- ifelse(df$dyslip==1, 1, ifelse(df$lipid.drugs==1, 1, 0))
table(df$dyslip, useNA = "ifany")

# CONVERT UNITS and recode some variables
df <- df %>% mutate(across(starts_with("glycated_haemoglobin_hba1c_f30750"), ~(.x*0.0915)+2.15))
summary(df$glycated_haemoglobin_hba1c_f30750_0_0)
df <- df %>% mutate(across(starts_with("glucose_f30740"), ~(.x*18.018)))
summary(df$glucose_f30740_0_0); summary(df$glucose_f30740_1_0)
df <- df %>% mutate(across(starts_with("total_bilirubin_f30840"), ~(.x/17.1)))
summary(df$total_bilirubin_f30840_0_0); summary(df$total_bilirubin_f30840_1_0)
df <- df %>% mutate(across(starts_with("albumin_f30600"), ~(.x/10)))
summary(df$albumin_f30600_0_0); summary(df$albumin_f30600_1_0)
table(df$alcohol.high <- case_when(df$alcohol_g_day>30 & df$sex_f31_0_0=="Male" ~1, df$alcohol_g_day>20 & df$sex_f31_0_0=="Female" ~1, TRUE~0), useNA = "ifany")
table(df$alcohol.high2 <- case_when(df$alcohol_g_day>60 & df$sex_f31_0_0=="Male" ~1, df$alcohol_g_day>50 & df$sex_f31_0_0=="Female" ~1, TRUE~0), useNA = "ifany")
table(df$bmi_cat <- factor(case_when(df$body_mass_index_bmi_f21001_0_0>=30~2, df$body_mass_index_bmi_f21001_0_0>=25~1, is.na(df$body_mass_index_bmi_f21001_0_0)~NA_real_, TRUE~0), levels = 0:2, labels = c("<25", "25-30", "≥30")), useNA = "ifany")
summary(df$pdff)
table(df$pdff.high, useNA = "ifany")
summary(df$ct1)
table(df$pdff.ct1 <- as.numeric(df$pdff.high==1 & df$ct1>800), useNA = "ifany")

# import some desciptive functions
tab.mean <- 
  function (row, cols = NULL, d = 1, print.sd = TRUE, all = FALSE,p.value = FALSE) 
  {col.all.mean <- round(mean(row, na.rm = TRUE), d)
    col.all.sd <- sprintf("(%s)", round(sd(row, na.rm = TRUE), d))
    if (is.null(cols)) {entry.mean <- round(mean(row, na.rm = TRUE), d)
      entry.sd <- sprintf("(%s)", round(sd(row, na.rm = TRUE), d))
      if (print.sd) {entry <- paste(entry.mean, entry.sd)}
      if (!print.sd) {entry <- entry.mean}
      return(entry)}
    if (!is.null(cols)) {entry.mean <- round(by(row, cols, mean, na.rm = TRUE), d)
      entry.sd <- sprintf("(%s)", round(by(row, cols, sd, na.rm = TRUE), d))
      if (all & print.sd) {entry <- c(paste(col.all.mean, col.all.sd), paste(entry.mean, entry.sd))}
      if (all & !print.sd) {entry <- c(entry.mean, col.all.mean)}
      if (!all & print.sd) {entry <- paste(entry.mean, entry.sd)}
      if (!all & !print.sd) {entry <- entry.mean}
      if (p.value) {entry <- c(entry, p(summary(aov(row ~ cols))[[1]][[1, 5]]))}
      if (all & !p.value) {names(entry) <- c("All", levels(as.factor(cols)))}
      if (all & p.value) {names(entry) <- c("All", levels(as.factor(cols)), "p")}
      if (!all & p.value) {names(entry) <- c(levels(as.factor(cols)), "p")}
      if (!all & !p.value) {names(entry) <- levels(as.factor(cols))}
      return(entry)}}

tab.median <- 
  function (row, cols = NULL, d = 1, print.1_3quart = TRUE, print.iqr = FALSE, p.value = FALSE, all = FALSE) 
  {col.all.median <- round(median(row, na.rm = TRUE), d)
    col.all.iqr <- round(IQR(row, na.rm = TRUE), d)
    col.all.iqr <- sprintf("(%s)", col.all.iqr)
    col.all.1_3quart <- sprintf("(%s-%s)", round(quantile(row, probs = 0.25, na.rm = TRUE), d), round(quantile(row, probs = 0.75, na.rm = TRUE), d))
    if (is.null(cols)) {entry.median <- round(median(row, na.rm = TRUE), d)
      entry.iqr <- sprintf("(%s)", round(IQR(row, na.rm = TRUE), d))
      entry.1_3quart <- sprintf("(%s-%s)", round(quantile(row, probs = 0.25, na.rm = TRUE), d), round(quantile(row, probs = 0.75, na.rm = TRUE), d))
      if (print.iqr & !print.1_3quart) {entry <- c(paste(entry.median, entry.iqr))}
      if (!print.iqr & print.1_3quart) {entry <- c(paste(entry.median, entry.1_3quart))}
      if (!print.iqr & !print.1_3quart) {entry <- c(entry.median)}
      else {names(entry) <- names(row)}
      return(entry)}
    if (!is.null(cols)) {
      entry.median <- round(by(row, cols, median, na.rm = TRUE), d)
      entry.iqr <- sprintf("(%s)", round(by(row, cols, IQR, na.rm = TRUE), d))
      entry.1_3quart <- sprintf("(%s-%s)", round(by(row, cols, FUN = function(x) {quantile(x, probs = 0.25, na.rm = TRUE)}), d), round(by(row, cols, FUN = function(x) {quantile(x, probs = 0.75, na.rm = TRUE)}), d))
      if (all & print.iqr & !print.1_3quart) {entry <- c(paste(col.all.median, col.all.iqr), paste(entry.median, entry.iqr))}
      if (all & !print.iqr & print.1_3quart) {entry <- c(paste(col.all.median, col.all.1_3quart), paste(entry.median, entry.1_3quart))}
      if (all & !print.iqr & !print.1_3quart) {entry <- c(col.all.median, entry.median)}
      if (!all & print.iqr & !print.1_3quart) {entry <- paste(entry.median, entry.iqr)}
      if (!all & !print.iqr & print.1_3quart) {entry <- paste(entry.median, entry.1_3quart)}
      if (!all & !print.iqr & !print.1_3quart) {entry <- entry.median}
      if (p.value) {entry <- c(entry, p(kruskal.test(row, cols)$p.value))}
      if (all & !p.value) {names(entry) <- c("All", levels(as.factor(cols)))}
      if (!all & p.value) {names(entry) <- c(levels(as.factor(cols)), "p")}
      if (all & p.value) {names(entry) <- c("All", levels(as.factor(cols)), "p")}
      if (!all & !p.value) {names(entry) <- levels(as.factor(cols))}
      return(entry)}}

tab.countpct <- function (row, cols = NULL, all = FALSE, d = 0, print.pct = "yes", p.value = FALSE) 
{require(Hmisc)
  All.pct <- prop.table(table(row)) * 100
  All.count <- table(row)
  if (is.null(cols)) {
    entry.count <- table(row)[2]
    entry.pct <- round(prop.table(table(row))[2] * 100, d)
    entry <- paste0(entry.count, " (", entry.pct, "%)")}
  if (!is.null(cols)) {
    tab.pct <- prop.table(table(row, cols), 2) * 100
    entry.pct <- round(tab.pct[-1, ], d)
    tab.count <- table(row, cols)[-1, ]
    entry <- paste0(tab.count, " (", entry.pct, "%)")}
  if (!is.null(cols) & all) {
    tab.count <- table(row, cols)
    tab.count <- cbind(All.count, tab.count)
    tab.count <- tab.count[-1, ]
    tab.pct <- prop.table(table(row, cols), 2) * 100
    tab.pct <- cbind(All.pct, tab.pct)
    tab.pct <- round(tab.pct[-1, ], d)
    entry <- paste0(tab.count, " (", tab.pct, "%)")}
  if (print.pct == "yes") {
    entry2 <- entry
    for (i in 1:length(entry2)) entry[i] <- entry2[i]}
  if (print.pct == "latex") {
    entry2 <- entry
    for (i in 1:length(entry2)) entry[i] <- latexTranslate(sprintf("%s\\%%", entry2[i]))}
  if (p.value) {entry <- c(entry, p(chisq.test(row, cols)$p.value))}
  if (all & !p.value) {names(entry) <- c("All", levels(as.factor(cols)))}
  if (all & p.value) {names(entry) <- c("All", levels(as.factor(cols)), "p")}
  if (!all & p.value) {names(entry) <- c(levels(as.factor(cols)), "p")}
  if (!all & !p.value) {names(entry) <- c(levels(as.factor(cols)))}
  return(entry)}

tab.mcountpct <- function (row, cols = NULL, first.cat = FALSE, all = FALSE, d = 0, p.value = FALSE) 
  {require(Hmisc)
  lev <- length(levels(as.factor(row)))
  lev.cols <- length(levels(as.factor(cols)))
  All.pct <- round(prop.table(table(row))[2:lev] * 100, d)
  All.pct.f <- round(prop.table(table(row))[1:lev] * 100, d)
  All.count <- table(row)[2:lev]
  All.count.f <- table(row)[1:lev]
  All.entry <- paste(paste0(All.count, " (", All.pct, "%)"), collapse = " / ")
  All.entry.f <- paste(paste0(All.count.f, " (", All.pct.f, "%)"), collapse = " / ")
  if (is.null(cols) & !first.cat) {
    entry.count <- table(row)[2:lev]
    entry.pct <- round(prop.table(table(row))[2:lev] * 100, d)
    entry <- paste(paste0(entry.count, " (", entry.pct, "%)"), collapse = " / ")}
  if (is.null(cols) & first.cat) {
    entry.count <- table(row)[1:lev]
    entry.pct <- round(prop.table(table(row))[1:lev] * 100, d)
    entry <- paste(paste0(entry.count, " (", entry.pct, "%)"), collapse = " / ")}
  if (!is.null(cols) & !first.cat) {
    tab.count <- table(row, cols)
    tab.pct <- round(prop.table(table(row, cols), 2) * 100, d)
    tab.cp <- paste0(tab.count, " (", tab.pct, "%)")
    dim(tab.cp) <- c(length(levels(as.factor(row))), length(levels(as.factor(cols))))
    tab.cp <- tab.cp[-1, ]
    entry <- c()
    for (i in 1:ncol(tab.cp)) {entry[i] <- paste(tab.cp[, i], collapse = " / ")}}
  if (!is.null(cols) & first.cat) {
    tab.count <- table(row, cols)
    tab.pct <- round(prop.table(table(row, cols), 2) * 100, d)
    tab.cp <- paste0(tab.count, " (", tab.pct, "%)")
    dim(tab.cp) <- c(length(levels(as.factor(row))), length(levels(as.factor(cols))))
    entry <- c()
    for (i in 1:ncol(tab.cp)) {entry[i] <- paste(tab.cp[, i], collapse = " / ")}}
  if (all & !first.cat) {entry <- c(All.entry, entry)}
  if (all & first.cat) {entry <- c(All.entry.f, entry)}
  if (p.value) {entry <- c(entry, p(chisq.test(row, cols)$p.value))}
  if (all & !p.value) {names(entry) <- c("All", levels(as.factor(cols)))}
  if (all & p.value) {names(entry) <- c("All", levels(as.factor(cols)), "p")}
  if (!all & p.value) {names(entry) <- c(levels(as.factor(cols)), "p")}
  if (!all & !p.value) {names(entry) <- c(levels(as.factor(cols)))}
  return(entry)}

# DEFINE OUTCOME: CHRONIC LIVER DISEASE (CLD)
df$cld.deceased <-case_when(df$ttexcl.chrlivdis.fu <= df$cld.deceased ~ 0, df$cld.inc==1 ~ 1, df$cld.icd.deceased==1 ~ 1, TRUE ~ 0)
df$ttcld.deceased <- case_when(df$ttexcl.chrlivdis.fu <= df$ttcld.inc ~ df$ttexcl.chrlivdis.fu,
                               df$cld.inc==1 ~ df$ttcld.inc, df$deceased==1 ~ df$ttdeath, TRUE ~ df$ttdeath)

# DEFINE OUTCOME: CARDIOVASCULAR DISEASE (CVD)
df$cvd.deceased <-case_when(df$cvd.icd==1 ~ 1, df$cvd.icd.deceased==1 ~ 1, TRUE ~ 0)
df$ttcvd.deceased <- case_when(df$cvd.icd==1 ~ df$ttcvd.icd, df$deceased==1 ~ df$ttdeath, TRUE ~ df$ttdeath)

save(list="df", file="data.RDATA")

# CHRONIC LIVER DISEASE COHORT ####
load("data.RDATA")

# SELECTION CRITERIA#
df <- df %>% 
  filter(body_mass_index_bmi_f21001_0_0>=25 | diab==1) %>% 
  filter(chrlivdis!=1) %>% filter(excl.chrlivdis==0 | excl.chrlivdis==1 & ttexcl.chrlivdis>0) %>%  # Exclude ALL chronic viral hepatitis and other causes of liver disease (registers and self reported)
nrow(df)

# df <- df %>% dplyr::filter(body_mass_index_bmi_f21001_0_0>=27) # SENSITIVITY 1: BMI≥27
# df <- df %>% dplyr::filter(alcohol.high2==0) # SENSITIVITY 2: excluding excessive alcohol consumption (>50/60 g/d in women/men)

# Cluster analysis #
df <- df %>% drop_na(age_when_attended_assessment_centre_f21003_0_0, body_mass_index_bmi_f21001_0_0, glycated_haemoglobin_hba1c_f30750_0_0, alanine_aminotransferase_f30620_0_0, triglycerides_f30870_0_0, ldl_direct_f30780_0_0)
df_c <- df %>% dplyr::select(eid, aspartate_aminotransferase_f30650_0_0, alanine_aminotransferase_f30620_0_0, hdl_cholesterol_f30760_0_0, glycated_haemoglobin_hba1c_f30750_0_0, waist_circumference_f48_0_0, albumin_f30600_0_0)

# Scale the data with respect to ABOS values
data_scale = data.frame(eid = df$eid,
                        Age = (df$age_when_attended_assessment_centre_f21003_0_0 -41.739687)/11.6751622,
                        BMI = (df$body_mass_index_bmi_f21001_0_0 -47.181508)/7.8642395,
                        hba1cpc = (df$glycated_haemoglobin_hba1c_f30750_0_0 -6.317347)/1.4289754,
                        TGPUL = (df$alanine_aminotransferase_f30620_0_0-33.266003)/22.1955482,
                        triglymmolL = (df$triglycerides_f30870_0_0 -1.654713)/1.0821998,
                        LDLmmolL = (df$ldl_direct_f30780_0_0 -3.057465)/0.8430835)

# Remove outliers -> those with an absolute value greater than 5
library(conflicted)
conflicts_prefer(base::min)
toRemove = unlist(apply(data_scale[,2:7], 2, function(r) which(abs(r) > 5)))
if (length(toRemove) > 0) data_scale = data_scale[-toRemove,]

# Calculate distance to all centers
distMatrix = data.frame(distClust1 = sqrt((data_scale$Age-0.8788154)^2 + (data_scale$BMI-(-0.06122751))^2 + (data_scale$hba1cpc-(-0.22208015))^2 + (data_scale$TGPUL-(-0.1471468))^2 + (data_scale$triglymmolL-(-0.10692422))^2 + (data_scale$LDLmmolL-(-0.8744864))^2),
                        distClust2 = sqrt((data_scale$Age-1.0501193)^2 + (data_scale$BMI-(-0.08665909))^2 + (data_scale$hba1cpc-1.52742507)^2 + (data_scale$TGPUL-0.8440430)^2 + (data_scale$triglymmolL-0.76260098)^2 + (data_scale$LDLmmolL-(-0.9340297))^2),
                        distClust3 = sqrt((data_scale$Age-(-0.7485709))^2 + (data_scale$BMI-1.71898277)^2 + (data_scale$hba1cpc-(-0.57198120))^2 + (data_scale$TGPUL-(-0.3724172))^2 + (data_scale$triglymmolL-(-0.23536631))^2 + (data_scale$LDLmmolL-(-0.2223564))^2),
                        distClust4 = sqrt((data_scale$Age-0.3649040)^2 + (data_scale$BMI-(-0.21381697))^2 + (data_scale$hba1cpc-(-0.36204057))^2 + (data_scale$TGPUL-(-0.2372549))^2 + (data_scale$triglymmolL-(-0.05055755))^2 + (data_scale$LDLmmolL-1.0942392)^2),
                        distClust5 = sqrt((data_scale$Age-(-0.2346594))^2 + (data_scale$BMI-(-0.29011169))^2 + (data_scale$hba1cpc-(-0.08211973))^2 + (data_scale$TGPUL-2.2407195)^2 + (data_scale$triglymmolL-0.09728946)^2 + (data_scale$LDLmmolL-0.3944271)^2),
                        distClust6 = sqrt((data_scale$Age-(-1.0055267))^2 + (data_scale$BMI-(-0.32825905))^2 + (data_scale$hba1cpc-(-0.64196140))^2 + (data_scale$TGPUL-(-0.4625253))^2 + (data_scale$triglymmolL-(-0.33701112))^2 + (data_scale$LDLmmolL-(-0.3765523))^2),
                        eid = data_scale$eid)

# Identify the minimum
distMatrix$min = unlist(apply(distMatrix, 1, function(r) min(r[1:6])))
# And the associated cluster
distMatrix$cluster = unlist(apply(distMatrix, 1, function(r) which(r[1:6] == r[8])))
# Check values
df <- merge(df, distMatrix[,c("eid", "cluster")], by = "eid")
table(df$cluster, useNA="ifany")

# Supplementary table 2
table(df$alt.high <- case_when(df$sex_f31_0_0=="Male" & df$alanine_aminotransferase_f30620_0_0>42~1, df$sex_f31_0_0=="Female" & df$alanine_aminotransferase_f30620_0_0>30~1, TRUE~0), useNA="ifany")
table(df$ast.high <- case_when(df$sex_f31_0_0=="Male" & df$aspartate_aminotransferase_f30650_0_0>42~1, df$sex_f31_0_0=="Female" & df$aspartate_aminotransferase_f30650_0_0>30~1, TRUE~0), useNA="ifany")
df$prs <- 0.266*df$pnpla3 + 0.274*df$tm6sf2 + 0.065*df$gckr + 0.063*df$mboat7
table(df$prs_cat <- case_when(df$prs<quantile(df$prs, 0.1, na.rm = TRUE)~0, df$prs>quantile(df$prs, 0.9, na.rm = TRUE)~2, TRUE~1), useNA = "ifany")
tab.mcountpct(df$prs_cat, first.cat = TRUE)
quantile(df$prs, 0.1, na.rm = TRUE)
quantile(df$prs, 0.9, na.rm = TRUE)
df$prs5 <- df$prs^(1+0.351*df$hsd)
table(df$alcohol.high); table(df$alcohol.high2)

table <- 
  rbind(
    "N"=c(nrow(df), nrow(df %>% filter(df$cluster==1)), nrow(df %>% filter(df$cluster==2)), nrow(df %>% filter(df$cluster==3)), nrow(df %>% filter(df$cluster==4)), nrow(df %>% filter(df$cluster==5)), nrow(df %>% filter(df$cluster==6)), ""),
    "Age, years"=c(tab.mean(df$age_when_attended_assessment_centre_f21003_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Women, n (%)"=c(tab.countpct(df$sex_f31_0_0=="Female", df$cluster, all = TRUE, p.value = TRUE)),
    "BMI, kg/m2"=c(tab.mean(df$body_mass_index_bmi_f21001_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "BMI cat"=c(tab.mcountpct(df$bmi_cat, df$cluster, first.cat=TRUE, all = TRUE, p.value = TRUE)),
    "Waist circumference, cm"=c(tab.mean(df$waist_circumference_f48_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Alcohol, high2"= c(tab.countpct(df$alcohol.high2, df$cluster, all = TRUE, p.value = TRUE)),
    "pdff"=c(tab.median(df$pdff, df$cluster, all = TRUE, p.value = TRUE)),
    "pdff NA"=c(tab.countpct(is.na(df$pdff), df$cluster, all = TRUE, p.value = TRUE)),
    "pdff>5.5%, n (%)"=c(tab.countpct(df$pdff.high, df$cluster, all = TRUE, p.value = TRUE)),
    "ct1"=c(tab.median(df$ct1, df$cluster, all = TRUE, p.value = TRUE)),
    "ct1 NA"=c(tab.countpct(is.na(df$ct1), df$cluster, all = TRUE, p.value = TRUE)),
    "pdff>5.5 and ct1>800"=c(tab.countpct(df$pdff.ct1, df$cluster, all = TRUE, p.value = TRUE)),
    "Glucose mg/dL"=c(tab.mean(df$glucose_f30740_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "HbA1c, %"= c(tab.median(df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Total cholesterol, mmol/L"= c(tab.mean(df$cholesterol_f30690_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "LDL cholesterol, mmol/L"= c(tab.mean(df$ldl_direct_f30780_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "HDL cholesterol, mmol/L"= c(tab.mean(df$hdl_cholesterol_f30760_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Triglycerides, mmol/L"= c(tab.median(df$triglycerides_f30870_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "ALT, U/L"= c(tab.median(df$alanine_aminotransferase_f30620_0_0, df$cluster, d=0, all = TRUE, p.value = TRUE)),
    "AST, U/L"= c(tab.median(df$aspartate_aminotransferase_f30650_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "ALP, U/L"=c(tab.median(df$alkaline_phosphatase_f30610_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "GGT, U/L"=c(tab.median(df$gamma_glutamyltransferase_f30730_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Bilirubin, mg/dL"=c(tab.mean(df$total_bilirubin_f30840_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Albumin, g/dL"=c(tab.mean(df$albumin_f30600_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Platelets, 10e3/uL"=c(tab.mean(df$platelet_count_f30080_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Hypertension, n (%)"=c(tab.countpct(df$ipert, df$cluster, all = TRUE, p.value = TRUE)),
    "Dyslipidemia, n (%)"=c(tab.countpct(df$dyslip, df$cluster, all = TRUE, p.value = TRUE)),
    "Type 2 diabetes, n (%)"=c(tab.countpct(df$diab, df$cluster, all = TRUE, p.value = TRUE)),
    "PNPLA3 rs738409 C>G (CC/CG/GG), n (%)"= c(tab.mcountpct(df$pnpla3, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "TM6SF2 rs58542926 C>T (CC, CT, TT), n (%)"= c(tab.mcountpct(df$tm6sf2, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "MBOAT7 rs641738 C>T (CC, CT, TT), n (%)"= c(tab.mcountpct(df$mboat7, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "GCKR rs1260326 C>T, n (%)"= c(tab.mcountpct(df$gckr, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "PRS"=c(tab.median(df$prs, df$cluster, all = TRUE, d=3, p.value = TRUE)),
    "PRS CAT"=c(tab.mcountpct(df$prs_cat, df$cluster, all = TRUE, first.cat = TRUE, p.value = TRUE)),
    "CLD, n (%)"=c(tab.countpct(df$cld.deceased, df$cluster, all=TRUE, p.value = TRUE, d=3)),
    "Follow-up"=c(tab.median(df$ttcld.deceased, df$cluster, all = TRUE, d=1, p.value = TRUE)))
table
View(table)
write.table(table[, -c(1,8)], quote = FALSE, sep=";")


table.globalp <- 
  rbind(
    "Age, years"=summary(aov(df$age_when_attended_assessment_centre_f21003_0_0 ~ df$cluster))[[1]][[1,5]],
    "Women, n (%)"=chisq.test(df$sex_f31_0_0=="Female", df$cluster)$p.value,
    "BMI, kg/m2"=summary(aov(df$body_mass_index_bmi_f21001_0_0 ~ df$cluster))[[1]][[1,5]],
    "BMI cat"=chisq.test(df$bmi_cat, df$cluster)$p.value,
    "Waist circumference, cm"=summary(aov(df$waist_circumference_f48_0_0 ~ df$cluster))[[1]][[1,5]],
    "Alcohol, high2"= chisq.test(df$alcohol.high2, df$cluster)$p.value,
    "pdff"=summary(aov(df$pdff ~ df$cluster))[[1]][[1,5]],
    "pdff NA"=chisq.test(is.na(df$pdff), df$cluster)$p.value,
    "pdff>5.5%, n (%)"=chisq.test(df$pdff.high, df$cluster)$p.value,
    "ct1"=summary(aov(df$ct1 ~ df$cluster))[[1]][[1,5]],
    "ct1 NA"=chisq.test(is.na(df$ct1), df$cluster)$p.value,
    "pdff>5.5 and ct1>800"=chisq.test(df$pdff.ct1, df$cluster)$p.value,
    "Glucose mg/dL"=summary(aov(df$glucose_f30740_0_0 ~ df$cluster))[[1]][[1,5]],
    "HbA1c, %"= kruskal.test(df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster)$p.value,
    "Total cholesterol, mmol/L"= summary(aov(df$cholesterol_f30690_0_0 ~ df$cluster))[[1]][[1,5]],
    "LDL cholesterol, mmol/L"= summary(aov(df$ldl_direct_f30780_0_0 ~ df$cluster))[[1]][[1,5]],
    "HDL cholesterol, mmol/L"= summary(aov(df$hdl_cholesterol_f30760_0_0 ~ df$cluster))[[1]][[1,5]],
    "Triglycerides, mmol/L"= kruskal.test(df$triglycerides_f30870_0_0, df$cluster)$p.value,
    "ALT, U/L"= kruskal.test(df$alanine_aminotransferase_f30620_0_0, df$cluster)$p.value,
    "AST, U/L"= kruskal.test(df$aspartate_aminotransferase_f30650_0_0, df$cluster)$p.value,
    "ALP, U/L"=kruskal.test(df$alkaline_phosphatase_f30610_0_0, df$cluster)$p.value,
    "GGT, U/L"=kruskal.test(df$gamma_glutamyltransferase_f30730_0_0, df$cluster)$p.value,
    "Bilirubin, mg/dL"=summary(aov(df$total_bilirubin_f30840_0_0 ~ df$cluster))[[1]][[1,5]],
    "Albumin, g/dL"=summary(aov(df$albumin_f30600_0_0 ~ df$cluster))[[1]][[1,5]],
    "Platelets, 10e3/uL"=summary(aov(df$platelet_count_f30080_0_0 ~ df$cluster))[[1]][[1,5]],
    "Hypertension, n (%)"=chisq.test(df$ipert, df$cluster)$p.value,
    "Dyslipidemia, n (%)"=chisq.test(df$dyslip, df$cluster)$p.value,
    "Type 2 diabetes, n (%)"=chisq.test(df$diab, df$cluster)$p.value,
    "CLD, n (%)"=chisq.test(df$cld.deceased, df$cluster)$p.value,
    "Follow-up"=kruskal.test(df$ttcirr.deceased, df$cluster)$p.value)
p.adjust(table3.globalp, method = "bonferroni")

table.globalp2 <- 
  rbind(
    "PNPLA3 rs738409 C>G (CC/CG/GG), n (%)"= chisq.test(df$pnpla3, df$cluster)$p.value,
    "TM6SF2 rs58542926 C>T (CC, CT, TT), n (%)"= chisq.test(df$tm6sf2, df$cluster)$p.value,
    "MBOAT7 rs641738 C>T (CC, CT, TT), n (%)"= chisq.test(df$mboat7, df$cluster)$p.value,
    "GCKR rs1260326 C>T, n (%)"= chisq.test(df$gckr, df$cluster)$p.value,
    "PRS"=kruskal.test(df$prs, df$cluster)$p.value,
    "PRS CAT"=chisq.test(df$prs_cat, df$cluster)$p.value)
cbind(table.globalp2, p.adjust(c(table.globalp2), method = "bonferroni"))

# RECODE CLUSTERS
table(df$cluster)
table(df$cluster <- case_when(df$cluster==2~2, df$cluster==5~3, TRUE~1), useNA="ifany") # 2: metabolic; 3: genetic; 1 all the others

table3 <- 
  rbind(
    "N"=c(nrow(df), nrow(df %>% filter(df$cluster==1)), nrow(df %>% filter(df$cluster==2)), nrow(df %>% filter(df$cluster==3)), ""),
    "Age, years"=c(tab.mean(df$age_when_attended_assessment_centre_f21003_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Women, n (%)"=c(tab.countpct(df$sex_f31_0_0=="Female", df$cluster, all = TRUE, p.value = TRUE)),
    "BMI, kg/m2"=c(tab.mean(df$body_mass_index_bmi_f21001_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "BMI cat"=c(tab.mcountpct(df$bmi_cat, df$cluster, first.cat=TRUE, all = TRUE, p.value = TRUE)),
    "Waist circumference, cm"=c(tab.mean(df$waist_circumference_f48_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Alcohol, high2"= c(tab.countpct(df$alcohol.high2, df$cluster, all = TRUE, p.value = TRUE)),
    "pdff"=c(tab.median(df$pdff, df$cluster, all = TRUE, p.value = TRUE)),
    "pdff NA"=c(tab.countpct(is.na(df$pdff), df$cluster, all = TRUE, p.value = TRUE)),
    "pdff>5.5%, n (%)"=c(tab.countpct(df$pdff.high, df$cluster, all = TRUE, p.value = TRUE)),
    "ct1"=c(tab.median(df$ct1, df$cluster, all = TRUE, p.value = TRUE)),
    "ct1 NA"=c(tab.countpct(is.na(df$ct1), df$cluster, all = TRUE, p.value = TRUE)),
    "pdff>5.5 and ct1>800"=c(tab.countpct(df$pdff.ct1, df$cluster, all = TRUE, p.value = TRUE)),
    "Glucose mg/dL"=c(tab.mean(df$glucose_f30740_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "HbA1c, %"= c(tab.median(df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Total cholesterol, mmol/L"= c(tab.mean(df$cholesterol_f30690_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "LDL cholesterol, mmol/L"= c(tab.mean(df$ldl_direct_f30780_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "HDL cholesterol, mmol/L"= c(tab.mean(df$hdl_cholesterol_f30760_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Triglycerides, mmol/L"= c(tab.median(df$triglycerides_f30870_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "ALT, U/L"= c(tab.median(df$alanine_aminotransferase_f30620_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "AST, U/L"= c(tab.median(df$aspartate_aminotransferase_f30650_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "ALP, U/L"=c(tab.median(df$alkaline_phosphatase_f30610_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "GGT, U/L"=c(tab.median(df$gamma_glutamyltransferase_f30730_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Bilirubin, mg/dL"=c(tab.mean(df$total_bilirubin_f30840_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Albumin, g/dL"=c(tab.mean(df$albumin_f30600_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Platelets, 10e3/uL"=c(tab.mean(df$platelet_count_f30080_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Hypertension, n (%)"=c(tab.countpct(df$ipert, df$cluster, all = TRUE, p.value = TRUE)),
    "Dyslipidemia, n (%)"=c(tab.countpct(df$dyslip, df$cluster, all = TRUE, p.value = TRUE)),
    "Type 2 diabetes, n (%)"=c(tab.countpct(df$diab, df$cluster, all = TRUE, p.value = TRUE)),
    "PNPLA3 rs738409 C>G (CC/CG/GG), n (%)"= c(tab.mcountpct(df$pnpla3, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "TM6SF2 rs58542926 C>T (CC, CT, TT), n (%)"= c(tab.mcountpct(df$tm6sf2, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "MBOAT7 rs641738 C>T (CC, CT, TT), n (%)"= c(tab.mcountpct(df$mboat7, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "GCKR rs1260326 C>T, n (%)"= c(tab.mcountpct(df$gckr, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "PRS"=c(tab.median(df$prs, df$cluster, all = TRUE, d=3, p.value = TRUE)),
    "PRS CAT"=c(tab.mcountpct(df$prs_cat, df$cluster, all = TRUE, first.cat = TRUE, p.value = TRUE)),
    "SLD, n (%)"=c(tab.countpct(df$cirr.deceased, df$cluster, all=TRUE, p.value = TRUE, d=3)),
    "CLD, n (%)"=c(tab.countpct(df$cld.deceased, df$cluster, all=TRUE, p.value = TRUE, d=3)),
    "Follow-up"=c(tab.median(df$ttcld.deceased, df$cluster, all = TRUE, d=1, p.value = TRUE)))
table3[,2]
table3

# PAIRWISE COMPARISONS
library(fifer)
table.p <- 
  rbind(
    "Age, years"=c(p(pairwise.wilcox.test( df$age_when_attended_assessment_centre_f21003_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$age_when_attended_assessment_centre_f21003_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$age_when_attended_assessment_centre_f21003_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Women, n (%)"=c(p(chisq.post.hoc(table(df$cluster, df$sex_f31_0_0=="Female"), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$sex_f31_0_0=="Female"), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$sex_f31_0_0=="Female"), control = "bonferroni")[3,3])),
    "BMI, kg/m2"=c(p(pairwise.wilcox.test( df$body_mass_index_bmi_f21001_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$body_mass_index_bmi_f21001_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$body_mass_index_bmi_f21001_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "BMI cat"=c(p(p.adjust(chisq.test(df$bmi_cat[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$bmi_cat[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$bmi_cat[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "Waist circumference, cm"=c(p(pairwise.wilcox.test( df$waist_circumference_f48_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$waist_circumference_f48_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$waist_circumference_f48_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Alcohol high2"=c(p(chisq.post.hoc(table(df$cluster, df$alcohol.high), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$alcohol.high2), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$alcohol.high2), control = "bonferroni")[3,3])),
    "pdff"=c(p(pairwise.wilcox.test( df$pdff, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$pdff, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$pdff, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "pdff NA"=c(p(chisq.post.hoc(table(df$cluster, is.na(df$pdff)), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, is.na(df$pdff)), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, is.na(df$pdff)), control = "bonferroni")[3,3])),
    "pdff>5.5%, n (%)"=c(p(chisq.post.hoc(table(df$cluster, df$pdff.high), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$pdff.high), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$pdff.high), control = "bonferroni")[3,3])),
    "ct1"=c(p(pairwise.wilcox.test( df$ct1, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$ct1, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$ct1, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "ct1 NA"=c(p(chisq.post.hoc(table(df$cluster, is.na(df$ct1)), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, is.na(df$ct1)), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, is.na(df$ct1)), control = "bonferroni")[3,3])),
    "pdff>5.5 and ct1>800"=c(p(chisq.post.hoc(table(df$cluster, df$pdff.ct1), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$pdff.ct1), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$pdff.ct1), control = "bonferroni")[3,3])),
    "Glucose mg/dL"=c(p(pairwise.wilcox.test( df$glucose_f30740_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$glucose_f30740_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$glucose_f30740_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "HbA1c, %"= c(p(pairwise.wilcox.test( df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Total cholesterol, mmol/L"= c(p(pairwise.wilcox.test( df$cholesterol_f30690_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$cholesterol_f30690_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$cholesterol_f30690_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "LDL cholesterol, mmol/L"= c(p(pairwise.wilcox.test( df$ldl_direct_f30780_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$ldl_direct_f30780_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$ldl_direct_f30780_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "HDL cholesterol, mmol/L"= c(p(pairwise.wilcox.test( df$hdl_cholesterol_f30760_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$hdl_cholesterol_f30760_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$hdl_cholesterol_f30760_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Triglycerides, mmol/L"= c(p(pairwise.wilcox.test( df$triglycerides_f30870_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$triglycerides_f30870_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$triglycerides_f30870_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "ALT, U/L"= c(p(pairwise.wilcox.test( df$alanine_aminotransferase_f30620_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$alanine_aminotransferase_f30620_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$alanine_aminotransferase_f30620_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "AST, U/L"= c(p(pairwise.wilcox.test(df$aspartate_aminotransferase_f30650_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$aspartate_aminotransferase_f30650_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test(df$aspartate_aminotransferase_f30650_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "ALP, U/L"=c(p(pairwise.wilcox.test( df$alkaline_phosphatase_f30610_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$alkaline_phosphatase_f30610_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$alkaline_phosphatase_f30610_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "GGT, U/L"=c(p(pairwise.wilcox.test( df$gamma_glutamyltransferase_f30730_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$gamma_glutamyltransferase_f30730_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$gamma_glutamyltransferase_f30730_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Bilirubin, mg/dL"=c(p(pairwise.wilcox.test( df$total_bilirubin_f30840_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$total_bilirubin_f30840_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$total_bilirubin_f30840_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Albumin, g/dL"=c(p(pairwise.wilcox.test( df$albumin_f30600_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$albumin_f30600_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$albumin_f30600_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Platelets, 10e3/uL"=c(p(pairwise.wilcox.test( df$platelet_count_f30080_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$platelet_count_f30080_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$platelet_count_f30080_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Hypertension, n (%)"=c(p(chisq.post.hoc(table(df$cluster, df$ipert), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$ipert), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$ipert), control = "bonferroni")[3,3])),
    "Dyslipidemia, n (%)"=c(p(chisq.post.hoc(table(df$cluster, df$dyslip), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$dyslip), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$dyslip), control = "bonferroni")[3,3])),
    "Type 2 diabetes, n (%)"=c(p(chisq.post.hoc(table(df$cluster, df$diab), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$diab), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$diab), control = "bonferroni")[3,3])),
    "PNPLA3 rs738409 C>G (CC/CG/GG), n (%)"= c(p(p.adjust(chisq.test(df$pnpla3[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$pnpla3[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$pnpla3[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "TM6SF2 rs58542926 C>T (CC, CT, TT), n (%)"= c(p(p.adjust(chisq.test(df$tm6sf2[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$tm6sf2[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$tm6sf2[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "MBOAT7 rs641738 C>T (CC, CT, TT), n (%)"= c(p(p.adjust(chisq.test(df$mboat7[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$mboat7[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$mboat7[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "GCKR rs1260326 C>T, n (%)"= c(p(p.adjust(chisq.test(df$gckr[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$gckr[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$gckr[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "PRS"=c(p(pairwise.wilcox.test( df$prs, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$prs, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$prs, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "PRS CAT"= c(p(p.adjust(chisq.test(df$prs_cat[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$prs_cat[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$prs_cat[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "CLD, n (%)"= c(p(chisq.post.hoc(table(df$cluster, df$cld.deceased), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$cld.deceased), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$cld.deceased), control = "bonferroni")[3,3])),
    "Follow-up"=c(p(pairwise.wilcox.test(df$ttcirr.deceased, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$ttcirr.deceased, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test(df$ttcirr.deceased, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])))
table.p <- rbind("N"=c("", "", ""), table.p)
table.p
write.table(table.p, quote = FALSE, sep=";")
# table total
tab.tot <- cbind(table, table3[,2], table.p)
dim(table.p)
colnames(tab.tot) <- c(colnames(table), "CTRL", "2 vs CTRL", "5 vs CTRL", "2 vs 5")
tab.tot
write.table(tab.tot, quote = FALSE, sep = ";")

# COX regressions 
table(df$cluster)
library(survival)
cox.zph(coxph(Surv(ttcld.deceased, cld.deceased)~cluster, data = df))
coxph(Surv(ttcld.deceased, cld.deceased)~cluster, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% 
  bind_rows(coxph(Surv(ttcld.deceased, cld.deceased)~cluster+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1)) %>% 
  dplyr::select(estimate, conf.low, conf.high, p.value) %>% mutate(across(everything(), ~round(.x, 2))) %>% knitr::kable()

cox.zph(coxph(Surv(ttcld.deceased, cld.deceased)~as.factor(cluster), data = df))
coxph(Surv(ttcld.deceased, cld.deceased)~as.factor(cluster), data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% 
  bind_rows(coxph(Surv(ttcld.deceased, cld.deceased)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  dplyr::select(term, estimate, conf.low, conf.high, p.value) %>% mutate(hr=sprintf("%s (%s-%s), %s", round(estimate, 2), round(conf.low, 2), round(conf.high, 2), round(p.value, 3))) %>% dplyr::select(-estimate, -conf.low, -conf.high, -p.value) %>%
  bind_cols(tibble(type=c("Uni", "Uni", "Adj", "Adj"))) %>% 
  pivot_wider(names_from = term, values_from = hr) %>% 
  write.table(quote = FALSE, sep = ";")

# Supplementary table 13 and data for Supplementary Figure 6
bind_rows(
  coxph(Surv(ttcld.deceased, cld.deceased)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2),
  coxph(Surv(ttcld.deceased, cld.deceased)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day+alanine_aminotransferase_f30620_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2),
  coxph(Surv(ttcld.deceased, cld.deceased)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day+glycated_haemoglobin_hba1c_f30750_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2),
  coxph(Surv(ttcld.deceased, cld.deceased)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day+body_mass_index_bmi_f21001_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2),
  coxph(Surv(ttcld.deceased, cld.deceased)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day+triglycerides_f30870_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2),
  coxph(Surv(ttcld.deceased, cld.deceased)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day+ldl_direct_f30780_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  dplyr::select(term, estimate, conf.low, conf.high, p.value) %>% mutate(hr=sprintf("%s (%s-%s), %s", round(estimate, 2), round(conf.low, 2), round(conf.high, 2), round(p.value, 3))) %>% dplyr::select(-estimate, -conf.low, -conf.high, -p.value) %>%
  bind_cols(tibble(type=c( "adj", "adj","adj+ALT", "adj+ALT", "adj+HbA1c", "adj+HbA1c", "adj+BMI", "adj+BMI", "adj+trigly", "adj+trigly", "adj+LDL", "adj+LDL"))) %>% 
  pivot_wider(names_from = term, values_from = hr) %>% 
  write.table(quote = FALSE, sep = ";")

(cluster.crude <- coxph(Surv(ttcld.deceased, cld.deceased)~as.factor(cluster), data = df, subset= ttcld.deceased>0)) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% 
  bind_rows(coxph(Surv(ttcld.deceased, cld.deceased)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  bind_rows(coxph(Surv(ttcld.deceased, cld.deceased)~as.factor(cluster)+body_mass_index_bmi_f21001_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  bind_rows(coxph(Surv(ttcld.deceased, cld.deceased)~as.factor(cluster)+glycated_haemoglobin_hba1c_f30750_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>%
  bind_rows(coxph(Surv(ttcld.deceased, cld.deceased)~as.factor(cluster)+alanine_aminotransferase_f30620_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  bind_rows(coxph(Surv(ttcld.deceased, cld.deceased)~as.factor(cluster)+triglycerides_f30870_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  bind_rows(coxph(Surv(ttcld.deceased, cld.deceased)~as.factor(cluster)+ldl_direct_f30780_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  dplyr::select(term, estimate, conf.low, conf.high, p.value) %>% mutate(hr=sprintf("%s (%s-%s), %s", round(estimate, 2), round(conf.low, 2), round(conf.high, 2), round(p.value, 3))) %>% dplyr::select(-estimate, -conf.low, -conf.high, -p.value) %>%
  bind_cols(tibble(type=c("Cluster", "Cluster", "Cluster+Age", "Cluster+Age", "Cluster+BMI", "Cluster+BMI", "Cluster+HbA1c", "Cluster+HbA1c", "Cluster+ALT", "Cluster+ALT", "Cluster+Triglycerides", "Cluster+Triglycerides", "Cluster+LDL", "Cluster+LDL"))) %>% 
  pivot_wider(names_from = term, values_from = hr) %>% 
  write.table(quote = FALSE, sep = ";")

(age.crude <- coxph(Surv(ttcld.deceased, cld.deceased)~age_when_attended_assessment_centre_f21003_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% 
  bind_rows((bmi.crude <- coxph(Surv(ttcld.deceased, cld.deceased)~body_mass_index_bmi_f21001_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE)) %>% 
  bind_rows((hba1c.crude <- coxph(Surv(ttcld.deceased, cld.deceased)~glycated_haemoglobin_hba1c_f30750_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE))  %>%
  bind_rows((alt.crude <- coxph(Surv(ttcld.deceased, cld.deceased)~alanine_aminotransferase_f30620_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE))  %>% 
  bind_rows((trigly.crude <- coxph(Surv(ttcld.deceased, cld.deceased)~triglycerides_f30870_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE))  %>% 
  bind_rows((ldl.crude <- coxph(Surv(ttcld.deceased, cld.deceased)~ldl_direct_f30780_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE)) %>% 
  dplyr::select(estimate, conf.low, conf.high, p.value) %>% mutate(hr=sprintf("%s (%s-%s), %s", round(estimate, 2), round(conf.low, 2), round(conf.high, 2), round(p.value, 3))) %>% dplyr::select(-estimate, -conf.low, -conf.high, -p.value) %>%
  bind_cols(tibble(type=c("Age", "BMI", "HbA1c", "ALT", "Triglycerides", "LDL")),.) %>% 
  write.table(quote = FALSE, sep = ";")


loglik <- 
rbind(c(as.numeric(anova(cluster.crude)$loglik[2]), NA),
as.numeric(anova(cluster.crude, update(age.crude, subset=ttcld.deceased>0))[2, c("loglik", "Pr(>|Chi|)")]),
as.numeric(anova(cluster.crude, update(bmi.crude, subset=ttcld.deceased>0))[2, c("loglik", "Pr(>|Chi|)")]),
as.numeric(anova(cluster.crude, update(hba1c.crude, subset=ttcld.deceased>0))[2, c("loglik", "Pr(>|Chi|)")]),
as.numeric(anova(cluster.crude, update(alt.crude, subset=ttcld.deceased>0))[2, c("loglik", "Pr(>|Chi|)")]),
as.numeric(anova(cluster.crude, update(trigly.crude, subset=ttcld.deceased>0))[2, c("loglik", "Pr(>|Chi|)")]),
as.numeric(anova(cluster.crude, update(ldl.crude, subset=ttcld.deceased>0))[2, c("loglik", "Pr(>|Chi|)")])) %>% 
  as_tibble() %>% mutate(loglik=sprintf("%s, %s", round(V1, 0), round(V2, 3))) %>% select(loglik)
  
aic <- 
c(round(AIC(cluster.crude), 0),
round(AIC(update(age.crude, subset=ttcld.deceased>0)), 0),
round(AIC(update(bmi.crude, subset=ttcld.deceased>0)), 0),
round(AIC(update(hba1c.crude, subset=ttcld.deceased>0)), 0),
round(AIC(update(alt.crude, subset=ttcld.deceased>0)), 0),
round(AIC(update(trigly.crude, subset=ttcld.deceased>0)), 0),
round(AIC(update(ldl.crude, subset=ttcld.deceased>0)), 0))

# CUMULATIVE INCIDENCE CURVE CLD - FIGURE 5
df$cld.deceased.cr <- case_when(df$ttexcl.chrlivdis.fu<=df$ttcld.inc ~ 2, 
                                 df$cld.deceased==1~1, 
                                 df$deceased==1~2, TRUE ~ 0)
table(df$cld.deceased.cr, useNA = "ifany")
table(df$cld.deceased.cr <- as.factor(df$cld.deceased.cr), useNA = "ifany") ## cld.inc as COMPETING RISK variable: 0 censor, 1 cld, 2 death or competing liver disease
summary(df$cld.deceased.cr)

cld.cr.km<- survfit(Surv(ttcld.deceased, cld.deceased.cr)~cluster, data = df)
cld.cr.km
library(jskm)
library(ggfortify); library(ggsurvfit)
ggcuminc(cld.cr.km)+ add_confidence_interval()+scale_ggsurvfit()+
  labs(x="TIME (YEARS)", y="CLD CUMULATIVE INCIDENCE") + 
  scale_color_manual(labels = c("CONTROL","CARDIOMETABOLIC", "LIVER-SPECIFIC"), name="", values = c("gray", "red", "cyan")) +
  scale_fill_manual(labels = c("CONTROL","CARDIOMETABOLIC", "LIVER-SPECIFIC"), name="", values = c("gray", "red", "cyan")) +
  theme(axis.text = element_text(size=13), axis.title = element_text(size=13))
dev.off()

# CARDIOVASCULAR DISEASE COHORT ####
load("data.RDATA")

# SELECTION CRITERIA#
df <- df %>% 
  filter(body_mass_index_bmi_f21001_0_0>=25 | diab==1) %>% 
  filter(chrlivdis!=1) %>% filter(excl.chrlivdis==0 | excl.chrlivdis==1 & ttexcl.chrlivdis>0) %>%  # Exclude ALL chronic viral hepatitis and other causes of liver disease (registers and self reported)
  filter(cvd==0) %>% filter(cvd.deceased==0 | cvd.deceased==1 & ttcvd.deceased>0) #	Exclude BASELINE CVD: both self reported and with ICD codes in hospital and death registers
nrow(df)

# df <- df %>% dplyr::filter(body_mass_index_bmi_f21001_0_0>=27) # SENSITIVITY 1: BMI≥27
# df <- df %>% dplyr::filter(alcohol.high2==0) # SENSITIVITY 2: excluding excessive alcohol consumption (>50/60 g/d in women/men)

# Cluster analysis #
## variables for clustering : AST, ALT, HDL, HbA1c, Waist circumference, Albumin
df <- df %>% drop_na(age_when_attended_assessment_centre_f21003_0_0, body_mass_index_bmi_f21001_0_0, glycated_haemoglobin_hba1c_f30750_0_0, alanine_aminotransferase_f30620_0_0, triglycerides_f30870_0_0, ldl_direct_f30780_0_0)
df_c <- df %>% dplyr::select(eid, aspartate_aminotransferase_f30650_0_0, alanine_aminotransferase_f30620_0_0, hdl_cholesterol_f30760_0_0, glycated_haemoglobin_hba1c_f30750_0_0, waist_circumference_f48_0_0, albumin_f30600_0_0)

# Scale the data with respect to ABOS values
data_scale = data.frame(eid = df$eid,
                        Age = (df$age_when_attended_assessment_centre_f21003_0_0 -41.739687)/11.6751622,
                        BMI = (df$body_mass_index_bmi_f21001_0_0 -47.181508)/7.8642395,
                        hba1cpc = (df$glycated_haemoglobin_hba1c_f30750_0_0 -6.317347)/1.4289754,
                        TGPUL = (df$alanine_aminotransferase_f30620_0_0-33.266003)/22.1955482,
                        triglymmolL = (df$triglycerides_f30870_0_0 -1.654713)/1.0821998,
                        LDLmmolL = (df$ldl_direct_f30780_0_0 -3.057465)/0.8430835)

# Remove outliers -> those with an absolute value greater than 5
toRemove = unlist(apply(data_scale[,2:7], 2, function(r) which(abs(r) > 5)))
if (length(toRemove) > 0) data_scale = data_scale[-toRemove,]

# Calculate distance to all centers
distMatrix = data.frame(distClust1 = sqrt((data_scale$Age-0.8788154)^2 + (data_scale$BMI-(-0.06122751))^2 + (data_scale$hba1cpc-(-0.22208015))^2 + (data_scale$TGPUL-(-0.1471468))^2 + (data_scale$triglymmolL-(-0.10692422))^2 + (data_scale$LDLmmolL-(-0.8744864))^2),
                        distClust2 = sqrt((data_scale$Age-1.0501193)^2 + (data_scale$BMI-(-0.08665909))^2 + (data_scale$hba1cpc-1.52742507)^2 + (data_scale$TGPUL-0.8440430)^2 + (data_scale$triglymmolL-0.76260098)^2 + (data_scale$LDLmmolL-(-0.9340297))^2),
                        distClust3 = sqrt((data_scale$Age-(-0.7485709))^2 + (data_scale$BMI-1.71898277)^2 + (data_scale$hba1cpc-(-0.57198120))^2 + (data_scale$TGPUL-(-0.3724172))^2 + (data_scale$triglymmolL-(-0.23536631))^2 + (data_scale$LDLmmolL-(-0.2223564))^2),
                        distClust4 = sqrt((data_scale$Age-0.3649040)^2 + (data_scale$BMI-(-0.21381697))^2 + (data_scale$hba1cpc-(-0.36204057))^2 + (data_scale$TGPUL-(-0.2372549))^2 + (data_scale$triglymmolL-(-0.05055755))^2 + (data_scale$LDLmmolL-1.0942392)^2),
                        distClust5 = sqrt((data_scale$Age-(-0.2346594))^2 + (data_scale$BMI-(-0.29011169))^2 + (data_scale$hba1cpc-(-0.08211973))^2 + (data_scale$TGPUL-2.2407195)^2 + (data_scale$triglymmolL-0.09728946)^2 + (data_scale$LDLmmolL-0.3944271)^2),
                        distClust6 = sqrt((data_scale$Age-(-1.0055267))^2 + (data_scale$BMI-(-0.32825905))^2 + (data_scale$hba1cpc-(-0.64196140))^2 + (data_scale$TGPUL-(-0.4625253))^2 + (data_scale$triglymmolL-(-0.33701112))^2 + (data_scale$LDLmmolL-(-0.3765523))^2),
                        eid = data_scale$eid)

# Identify the minimum
distMatrix$min = unlist(apply(distMatrix, 1, function(r) min(r[1:6])))
# And the associated cluster
distMatrix$cluster = unlist(apply(distMatrix, 1, function(r) which(r[1:6] == r[8])))

# Check values
df <- merge(df, distMatrix[,c("eid", "cluster")], by = "eid")

# Supplementary table 3
table(df$alt.high <- case_when(df$sex_f31_0_0=="Male" & df$alanine_aminotransferase_f30620_0_0>42~1, df$sex_f31_0_0=="Female" & df$alanine_aminotransferase_f30620_0_0>30~1, TRUE~0), useNA="ifany")
table(df$ast.high <- case_when(df$sex_f31_0_0=="Male" & df$aspartate_aminotransferase_f30650_0_0>42~1, df$sex_f31_0_0=="Female" & df$aspartate_aminotransferase_f30650_0_0>30~1, TRUE~0), useNA="ifany")
df$prs <- 0.266*df$pnpla3 + 0.274*df$tm6sf2 + 0.065*df$gckr + 0.063*df$mboat7
table(df$prs_cat <- case_when(df$prs<quantile(df$prs, 0.1, na.rm = TRUE)~0, df$prs>quantile(df$prs, 0.9, na.rm = TRUE)~2, TRUE~1), useNA = "ifany")
tab.mcountpct(df$prs_cat, first.cat = TRUE)
quantile(df$prs, 0.1, na.rm = TRUE)
quantile(df$prs, 0.9, na.rm = TRUE)
df$prs5 <- df$prs^(1+0.351*df$hsd)

table <- 
  rbind(
    "N"=c(nrow(df), nrow(df %>% filter(df$cluster==1)), nrow(df %>% filter(df$cluster==2)), nrow(df %>% filter(df$cluster==3)), nrow(df %>% filter(df$cluster==4)), nrow(df %>% filter(df$cluster==5)), nrow(df %>% filter(df$cluster==6)), ""),
    "Age, years"=c(tab.mean(df$age_when_attended_assessment_centre_f21003_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Women, n (%)"=c(tab.countpct(df$sex_f31_0_0=="Female", df$cluster, all = TRUE, p.value = TRUE)),
    "BMI, kg/m2"=c(tab.mean(df$body_mass_index_bmi_f21001_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "BMI cat"=c(tab.mcountpct(df$bmi_cat, df$cluster, first.cat=TRUE, all = TRUE, p.value = TRUE)),
    "Waist circumference, cm"=c(tab.mean(df$waist_circumference_f48_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Alcohol, high2"= c(tab.countpct(df$alcohol.high2, df$cluster, all = TRUE, p.value = TRUE)),
    "pdff"=c(tab.median(df$pdff, df$cluster, all = TRUE, p.value = TRUE)),
    "pdff NA"=c(tab.countpct(is.na(df$pdff), df$cluster, all = TRUE, p.value = TRUE)),
    "pdff>5.5%, n (%)"=c(tab.countpct(df$pdff.high, df$cluster, all = TRUE, p.value = TRUE)),
    "ct1"=c(tab.median(df$ct1, df$cluster, all = TRUE, p.value = TRUE)),
    "ct1 NA"=c(tab.countpct(is.na(df$ct1), df$cluster, all = TRUE, p.value = TRUE)),
    "pdff>5.5 and ct1>800"=c(tab.countpct(df$pdff.ct1, df$cluster, all = TRUE, p.value = TRUE)),
    "Glucose mg/dL"=c(tab.mean(df$glucose_f30740_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "HbA1c, %"= c(tab.median(df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Total cholesterol, mmol/L"= c(tab.mean(df$cholesterol_f30690_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "LDL cholesterol, mmol/L"= c(tab.mean(df$ldl_direct_f30780_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "HDL cholesterol, mmol/L"= c(tab.mean(df$hdl_cholesterol_f30760_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Triglycerides, mmol/L"= c(tab.median(df$triglycerides_f30870_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "ALT, U/L"= c(tab.median(df$alanine_aminotransferase_f30620_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "AST, U/L"= c(tab.median(df$aspartate_aminotransferase_f30650_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "ALP, U/L"=c(tab.median(df$alkaline_phosphatase_f30610_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "GGT, U/L"=c(tab.median(df$gamma_glutamyltransferase_f30730_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Bilirubin, mg/dL"=c(tab.mean(df$total_bilirubin_f30840_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Albumin, g/dL"=c(tab.mean(df$albumin_f30600_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Platelets, 10e3/uL"=c(tab.mean(df$platelet_count_f30080_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Hypertension, n (%)"=c(tab.countpct(df$ipert, df$cluster, all = TRUE, p.value = TRUE)),
    "Dyslipidemia, n (%)"=c(tab.countpct(df$dyslip, df$cluster, all = TRUE, p.value = TRUE)),
    "Type 2 diabetes, n (%)"=c(tab.countpct(df$diab, df$cluster, all = TRUE, p.value = TRUE)),
    "PNPLA3 rs738409 C>G (CC/CG/GG), n (%)"= c(tab.mcountpct(df$pnpla3, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "TM6SF2 rs58542926 C>T (CC, CT, TT), n (%)"= c(tab.mcountpct(df$tm6sf2, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "MBOAT7 rs641738 C>T (CC, CT, TT), n (%)"= c(tab.mcountpct(df$mboat7, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "GCKR rs1260326 C>T, n (%)"= c(tab.mcountpct(df$gckr, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "PRS"=c(tab.median(df$prs, df$cluster, all = TRUE, d=3, p.value = TRUE)),
    "PRS CAT"=c(tab.mcountpct(df$prs_cat, df$cluster, all = TRUE, first.cat = TRUE, p.value = TRUE)),
    "CVD, n (%)"=c(tab.countpct(df$cvd.deceased, df$cluster, all=TRUE, p.value = TRUE, d=3)),
    "Follow-up"=c(tab.median(df$ttcvd.deceased, df$cluster, all = TRUE, d=1, p.value = TRUE)))
table
write.table(table[,-1], quote = FALSE, sep=";")

table.globalp <- 
  rbind(
    "Age, years"=summary(aov(df$age_when_attended_assessment_centre_f21003_0_0 ~ df$cluster))[[1]][[1,5]],
    "Women, n (%)"=chisq.test(df$sex_f31_0_0=="Female", df$cluster)$p.value,
    "BMI, kg/m2"=summary(aov(df$body_mass_index_bmi_f21001_0_0 ~ df$cluster))[[1]][[1,5]],
    "BMI cat"=chisq.test(df$bmi_cat, df$cluster)$p.value,
    "Waist circumference, cm"=summary(aov(df$waist_circumference_f48_0_0 ~ df$cluster))[[1]][[1,5]],
    "Alcohol, high2"= chisq.test(df$alcohol.high2, df$cluster)$p.value,
    "pdff"=summary(aov(df$pdff ~ df$cluster))[[1]][[1,5]],
    "pdff NA"=chisq.test(is.na(df$pdff), df$cluster)$p.value,
    "pdff>5.5%, n (%)"=chisq.test(df$pdff.high, df$cluster)$p.value,
    "ct1"=summary(aov(df$ct1 ~ df$cluster))[[1]][[1,5]],
    "ct1 NA"=chisq.test(is.na(df$ct1), df$cluster)$p.value,
    "pdff>5.5 and ct1>800"=chisq.test(df$pdff.ct1, df$cluster)$p.value,
    "Glucose mg/dL"=summary(aov(df$glucose_f30740_0_0 ~ df$cluster))[[1]][[1,5]],
    "HbA1c, %"= kruskal.test(df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster)$p.value,
    "Total cholesterol, mmol/L"= summary(aov(df$cholesterol_f30690_0_0 ~ df$cluster))[[1]][[1,5]],
    "LDL cholesterol, mmol/L"= summary(aov(df$ldl_direct_f30780_0_0 ~ df$cluster))[[1]][[1,5]],
    "HDL cholesterol, mmol/L"= summary(aov(df$hdl_cholesterol_f30760_0_0 ~ df$cluster))[[1]][[1,5]],
    "Triglycerides, mmol/L"= kruskal.test(df$triglycerides_f30870_0_0, df$cluster)$p.value,
    "ALT, U/L"= kruskal.test(df$alanine_aminotransferase_f30620_0_0, df$cluster)$p.value,
    "AST, U/L"= kruskal.test(df$aspartate_aminotransferase_f30650_0_0, df$cluster)$p.value,
    "ALP, U/L"=kruskal.test(df$alkaline_phosphatase_f30610_0_0, df$cluster)$p.value,
    "GGT, U/L"=kruskal.test(df$gamma_glutamyltransferase_f30730_0_0, df$cluster)$p.value,
    "Bilirubin, mg/dL"=summary(aov(df$total_bilirubin_f30840_0_0 ~ df$cluster))[[1]][[1,5]],
    "Albumin, g/dL"=summary(aov(df$albumin_f30600_0_0 ~ df$cluster))[[1]][[1,5]],
    "Platelets, 10e3/uL"=summary(aov(df$platelet_count_f30080_0_0 ~ df$cluster))[[1]][[1,5]],
    "Hypertension, n (%)"=chisq.test(df$ipert, df$cluster)$p.value,
    "Dyslipidemia, n (%)"=chisq.test(df$dyslip, df$cluster)$p.value,
    "Type 2 diabetes, n (%)"=chisq.test(df$diab, df$cluster)$p.value,
    "CVD, n (%)"=chisq.test(df$cvd.deceased, df$cluster)$p.value,
    "Follow-up"=kruskal.test(df$ttcirr.deceased, df$cluster)$p.value)
cbind(table.globalp, p.adjust(c(table.globalp), method = "bonferroni")) 

table.globalp2 <- 
  rbind(
    "PNPLA3 rs738409 C>G (CC/CG/GG), n (%)"= chisq.test(df$pnpla3, df$cluster)$p.value,
    "TM6SF2 rs58542926 C>T (CC, CT, TT), n (%)"= chisq.test(df$tm6sf2, df$cluster)$p.value,
    "MBOAT7 rs641738 C>T (CC, CT, TT), n (%)"= chisq.test(df$mboat7, df$cluster)$p.value,
    "GCKR rs1260326 C>T, n (%)"= chisq.test(df$gckr, df$cluster)$p.value,
    "PRS"=kruskal.test(df$prs, df$cluster)$p.value,
    "PRS CAT"=chisq.test(df$prs_cat, df$cluster)$p.value)
cbind(table.globalp2, p.adjust(c(table.globalp2), method = "bonferroni")) # all significant

# RECODE CLUSTERS
table(df$cluster)
table(df$cluster <- case_when(df$cluster==2~2, df$cluster==5~3, TRUE~1), useNA="ifany") # 2: metabolic; 3: genetic; 1 all the others

table3 <- 
  rbind(
    "N"=c(nrow(df), nrow(df %>% filter(df$cluster==1)), nrow(df %>% filter(df$cluster==2)), nrow(df %>% filter(df$cluster==3)), ""),
    "Age, years"=c(tab.mean(df$age_when_attended_assessment_centre_f21003_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Women, n (%)"=c(tab.countpct(df$sex_f31_0_0=="Female", df$cluster, all = TRUE, p.value = TRUE)),
    "BMI, kg/m2"=c(tab.mean(df$body_mass_index_bmi_f21001_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "BMI cat"=c(tab.mcountpct(df$bmi_cat, df$cluster, first.cat=TRUE, all = TRUE, p.value = TRUE)),
    "Waist circumference, cm"=c(tab.mean(df$waist_circumference_f48_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Alcohol, high2"= c(tab.countpct(df$alcohol.high2, df$cluster, all = TRUE, p.value = TRUE)),
    "pdff"=c(tab.median(df$pdff, df$cluster, all = TRUE, p.value = TRUE)),
    "pdff NA"=c(tab.countpct(is.na(df$pdff), df$cluster, all = TRUE, p.value = TRUE)),
    "pdff>5.5%, n (%)"=c(tab.countpct(df$pdff.high, df$cluster, all = TRUE, p.value = TRUE)),
    "ct1"=c(tab.median(df$ct1, df$cluster, all = TRUE, p.value = TRUE)),
    "ct1 NA"=c(tab.countpct(is.na(df$ct1), df$cluster, all = TRUE, p.value = TRUE)),
    "pdff>5.5 and ct1>800"=c(tab.countpct(df$pdff.ct1, df$cluster, all = TRUE, p.value = TRUE)),
    "Glucose mg/dL"=c(tab.mean(df$glucose_f30740_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "HbA1c, %"= c(tab.median(df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Total cholesterol, mmol/L"= c(tab.mean(df$cholesterol_f30690_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "LDL cholesterol, mmol/L"= c(tab.mean(df$ldl_direct_f30780_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "HDL cholesterol, mmol/L"= c(tab.mean(df$hdl_cholesterol_f30760_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Triglycerides, mmol/L"= c(tab.median(df$triglycerides_f30870_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "ALT, U/L"= c(tab.median(df$alanine_aminotransferase_f30620_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "AST, U/L"= c(tab.median(df$aspartate_aminotransferase_f30650_0_0, df$cluster, all = TRUE)),
    "ALP, U/L"=c(tab.median(df$alkaline_phosphatase_f30610_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "GGT, U/L"=c(tab.median(df$gamma_glutamyltransferase_f30730_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Bilirubin, mg/dL"=c(tab.mean(df$total_bilirubin_f30840_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Albumin, g/dL"=c(tab.mean(df$albumin_f30600_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Platelets, 10e3/uL"=c(tab.mean(df$platelet_count_f30080_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Hypertension, n (%)"=c(tab.countpct(df$ipert, df$cluster, all = TRUE, p.value = TRUE)),
    "Dyslipidemia, n (%)"=c(tab.countpct(df$dyslip, df$cluster, all = TRUE, p.value = TRUE)),
    "Type 2 diabetes, n (%)"=c(tab.countpct(df$diab, df$cluster, all = TRUE, p.value = TRUE)),
    "PNPLA3 rs738409 C>G (CC/CG/GG), n (%)"= c(tab.mcountpct(df$pnpla3, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "TM6SF2 rs58542926 C>T (CC, CT, TT), n (%)"= c(tab.mcountpct(df$tm6sf2, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "MBOAT7 rs641738 C>T (CC, CT, TT), n (%)"= c(tab.mcountpct(df$mboat7, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "GCKR rs1260326 C>T, n (%)"= c(tab.mcountpct(df$gckr, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "PRS"=c(tab.median(df$prs, df$cluster, all = TRUE, d=3, p.value = TRUE)),
    "PRS CAT"=c(tab.mcountpct(df$prs_cat, df$cluster, all = TRUE, first.cat = TRUE, p.value = TRUE)),
    "CVD, n (%)"=c(tab.countpct(df$cvd.deceased, df$cluster, all=TRUE, p.value = TRUE, d=3)),
    "Follow-up"=c(tab.median(df$ttcirr.deceased, df$cluster, all = TRUE, d=1, p.value = TRUE)))
table3[,2]
write.table(table3, quote = FALSE, sep=";")

# PAIRWISE COMPARISONS
library(fifer)
table.p <- 
  rbind(
    "Age, years"=c(p(pairwise.wilcox.test( df$age_when_attended_assessment_centre_f21003_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$age_when_attended_assessment_centre_f21003_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$age_when_attended_assessment_centre_f21003_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Women, n (%)"=c(p(chisq.post.hoc(table(df$cluster, df$sex_f31_0_0=="Female"), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$sex_f31_0_0=="Female"), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$sex_f31_0_0=="Female"), control = "bonferroni")[3,3])),
    "BMI, kg/m2"=c(p(pairwise.wilcox.test( df$body_mass_index_bmi_f21001_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$body_mass_index_bmi_f21001_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$body_mass_index_bmi_f21001_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "BMI cat"=c(p(p.adjust(chisq.test(df$bmi_cat[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$bmi_cat[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$bmi_cat[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "Waist circumference, cm"=c(p(pairwise.wilcox.test( df$waist_circumference_f48_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$waist_circumference_f48_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$waist_circumference_f48_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Alcohol high2"=c(p(chisq.post.hoc(table(df$cluster, df$alcohol.high), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$alcohol.high2), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$alcohol.high2), control = "bonferroni")[3,3])),
    "pdff"=c(p(pairwise.wilcox.test( df$pdff, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$pdff, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$pdff, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "pdff NA"=c(p(chisq.post.hoc(table(df$cluster, is.na(df$pdff)), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, is.na(df$pdff)), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, is.na(df$pdff)), control = "bonferroni")[3,3])),
    "pdff>5.5%, n (%)"=c(p(chisq.post.hoc(table(df$cluster, df$pdff.high), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$pdff.high), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$pdff.high), control = "bonferroni")[3,3])),
    "ct1"=c(p(pairwise.wilcox.test( df$ct1, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$ct1, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$ct1, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "ct1 NA"=c(p(chisq.post.hoc(table(df$cluster, is.na(df$ct1)), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, is.na(df$ct1)), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, is.na(df$ct1)), control = "bonferroni")[3,3])),
    "pdff>5.5 and ct1>800"=c(p(chisq.post.hoc(table(df$cluster, df$pdff.ct1), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$pdff.ct1), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$pdff.ct1), control = "bonferroni")[3,3])),
    "Glucose mg/dL"=c(p(pairwise.wilcox.test( df$glucose_f30740_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$glucose_f30740_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$glucose_f30740_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "HbA1c, %"= c(p(pairwise.wilcox.test( df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Total cholesterol, mmol/L"= c(p(pairwise.wilcox.test( df$cholesterol_f30690_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$cholesterol_f30690_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$cholesterol_f30690_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "LDL cholesterol, mmol/L"= c(p(pairwise.wilcox.test( df$ldl_direct_f30780_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$ldl_direct_f30780_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$ldl_direct_f30780_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "HDL cholesterol, mmol/L"= c(p(pairwise.wilcox.test( df$hdl_cholesterol_f30760_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$hdl_cholesterol_f30760_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$hdl_cholesterol_f30760_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Triglycerides, mmol/L"= c(p(pairwise.wilcox.test( df$triglycerides_f30870_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$triglycerides_f30870_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$triglycerides_f30870_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "ALT, U/L"= c(p(pairwise.wilcox.test( df$alanine_aminotransferase_f30620_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$alanine_aminotransferase_f30620_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$alanine_aminotransferase_f30620_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "AST, U/L"= c(p(pairwise.wilcox.test(df$aspartate_aminotransferase_f30650_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$aspartate_aminotransferase_f30650_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test(df$aspartate_aminotransferase_f30650_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "ALP, U/L"=c(p(pairwise.wilcox.test( df$alkaline_phosphatase_f30610_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$alkaline_phosphatase_f30610_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$alkaline_phosphatase_f30610_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "GGT, U/L"=c(p(pairwise.wilcox.test( df$gamma_glutamyltransferase_f30730_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$gamma_glutamyltransferase_f30730_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$gamma_glutamyltransferase_f30730_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Bilirubin, mg/dL"=c(p(pairwise.wilcox.test( df$total_bilirubin_f30840_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$total_bilirubin_f30840_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$total_bilirubin_f30840_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Albumin, g/dL"=c(p(pairwise.wilcox.test( df$albumin_f30600_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$albumin_f30600_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$albumin_f30600_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Platelets, 10e3/uL"=c(p(pairwise.wilcox.test( df$platelet_count_f30080_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$platelet_count_f30080_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$platelet_count_f30080_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Hypertension, n (%)"=c(p(chisq.post.hoc(table(df$cluster, df$ipert), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$ipert), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$ipert), control = "bonferroni")[3,3])),
    "Dyslipidemia, n (%)"=c(p(chisq.post.hoc(table(df$cluster, df$dyslip), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$dyslip), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$dyslip), control = "bonferroni")[3,3])),
    "Type 2 diabetes, n (%)"=c(p(chisq.post.hoc(table(df$cluster, df$diab), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$diab), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$diab), control = "bonferroni")[3,3])),
    "PNPLA3 rs738409 C>G (CC/CG/GG), n (%)"= c(p(p.adjust(chisq.test(df$pnpla3[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$pnpla3[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$pnpla3[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "TM6SF2 rs58542926 C>T (CC, CT, TT), n (%)"= c(p(p.adjust(chisq.test(df$tm6sf2[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$tm6sf2[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$tm6sf2[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "MBOAT7 rs641738 C>T (CC, CT, TT), n (%)"= c(p(p.adjust(chisq.test(df$mboat7[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$mboat7[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$mboat7[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "GCKR rs1260326 C>T, n (%)"= c(p(p.adjust(chisq.test(df$gckr[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$gckr[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$gckr[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "PRS"=c(p(pairwise.wilcox.test( df$prs, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$prs, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$prs, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "PRS CAT"= c(p(p.adjust(chisq.test(df$prs_cat[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$prs_cat[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$prs_cat[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "CVD, n (%)"= c(p(chisq.post.hoc(table(df$cluster, df$cvd.deceased), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$cvd.deceased), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$cvd.deceased), control = "bonferroni")[3,3])),
    "Follow-up"=c(p(pairwise.wilcox.test(df$ttcirr.deceased, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$ttcirr.deceased, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test(df$ttcirr.deceased, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])))
table.p <- rbind("N"=c("", "", ""), table.p)
table.p
write.table(table.p, quote = FALSE, sep=";")
# table total
tab.tot <- cbind(table, table3[,2], table.p)
colnames(tab.tot) <- c(colnames(table), "CTRL", "2 vs CTRL", "5 vs CTRL", "2 vs 5")
tab.tot
write.table(tab.tot, quote = FALSE, sep = ";")

# COX regressions
cox.zph(coxph(Surv(ttcvd.deceased, cvd.deceased)~cluster, data = df))
coxph(Surv(ttcvd.deceased, cvd.deceased)~cluster, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% 
  bind_rows(coxph(Surv(ttcvd.deceased, cvd.deceased)~cluster+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1)) %>% 
  dplyr::select(estimate, conf.low, conf.high, p.value) %>% mutate(across(everything(), ~round(.x, 2))) %>% knitr::kable()

cox.zph(coxph(Surv(ttcvd.deceased, cvd.deceased)~as.factor(cluster), data = df))
(cluster.crude <- coxph(Surv(ttcvd.deceased, cvd.deceased)~as.factor(cluster), data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% 
  bind_rows(coxph(Surv(ttcvd.deceased, cvd.deceased)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  dplyr::select(term, estimate, conf.low, conf.high, p.value) %>% mutate(hr=sprintf("%s (%s-%s), %s", round(estimate, 2), round(conf.low, 2), round(conf.high, 2), round(p.value, 3))) %>% dplyr::select(-estimate, -conf.low, -conf.high, -p.value) %>%
  bind_cols(tibble(type=c("Uni", "Uni", "Adj", "Adj"))) %>% 
  pivot_wider(names_from = term, values_from = hr) %>% 
  write.table(quote = FALSE, sep = ";")

# Supplementary table 13 and data for Supplementary Figure 6
bind_rows(
  coxph(Surv(ttcvd.deceased, cvd.deceased)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2),
  coxph(Surv(ttcvd.deceased, cvd.deceased)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day+alanine_aminotransferase_f30620_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2),
  coxph(Surv(ttcvd.deceased, cvd.deceased)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day+glycated_haemoglobin_hba1c_f30750_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2),
  coxph(Surv(ttcvd.deceased, cvd.deceased)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day+body_mass_index_bmi_f21001_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2),
  coxph(Surv(ttcvd.deceased, cvd.deceased)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day+triglycerides_f30870_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2),
  coxph(Surv(ttcvd.deceased, cvd.deceased)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day+ldl_direct_f30780_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  dplyr::select(term, estimate, conf.low, conf.high, p.value) %>% mutate(hr=sprintf("%s (%s-%s), %s", round(estimate, 2), round(conf.low, 2), round(conf.high, 2), round(p.value, 3))) %>% dplyr::select(-estimate, -conf.low, -conf.high, -p.value) %>%
  bind_cols(tibble(type=c( "adj", "adj","adj+ALT", "adj+ALT", "adj+HbA1c", "adj+HbA1c", "adj+BMI", "adj+BMI", "adj+trigly", "adj+trigly", "adj+LDL", "adj+LDL"))) %>% 
  pivot_wider(names_from = term, values_from = hr) %>% 
  write.table(quote = FALSE, sep = ";")

(cluster.crude <- coxph(Surv(ttcvd.deceased, cvd.deceased)~as.factor(cluster), data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% 
  bind_rows(coxph(Surv(ttcvd.deceased, cvd.deceased)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  bind_rows(coxph(Surv(ttcvd.deceased, cvd.deceased)~as.factor(cluster)+body_mass_index_bmi_f21001_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  bind_rows(coxph(Surv(ttcvd.deceased, cvd.deceased)~as.factor(cluster)+glycated_haemoglobin_hba1c_f30750_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>%
  bind_rows(coxph(Surv(ttcvd.deceased, cvd.deceased)~as.factor(cluster)+alanine_aminotransferase_f30620_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  bind_rows(coxph(Surv(ttcvd.deceased, cvd.deceased)~as.factor(cluster)+triglycerides_f30870_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  bind_rows(coxph(Surv(ttcvd.deceased, cvd.deceased)~as.factor(cluster)+ldl_direct_f30780_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  dplyr::select(term, estimate, conf.low, conf.high, p.value) %>% mutate(hr=sprintf("%s (%s-%s), %s", round(estimate, 2), round(conf.low, 2), round(conf.high, 2), round(p.value, 3))) %>% dplyr::select(-estimate, -conf.low, -conf.high, -p.value) %>%
  bind_cols(tibble(type=c("Cluster", "Cluster", "Cluster+Age", "Cluster+Age", "Cluster+BMI", "Cluster+BMI", "Cluster+HbA1c", "Cluster+HbA1c", "Cluster+ALT", "Cluster+ALT", "Cluster+Triglycerides", "Cluster+Triglycerides", "Cluster+LDL", "Cluster+LDL"))) %>% 
  pivot_wider(names_from = term, values_from = hr) %>% 
  write.table(quote = FALSE, sep = ";")

(age.crude <- coxph(Surv(ttcvd.deceased, cvd.deceased)~age_when_attended_assessment_centre_f21003_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% 
  bind_rows((bmi.crude <- coxph(Surv(ttcvd.deceased, cvd.deceased)~body_mass_index_bmi_f21001_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE)) %>% 
  bind_rows((hba1c.crude <- coxph(Surv(ttcvd.deceased, cvd.deceased)~glycated_haemoglobin_hba1c_f30750_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE))  %>%
  bind_rows((alt.crude <- coxph(Surv(ttcvd.deceased, cvd.deceased)~alanine_aminotransferase_f30620_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE))  %>% 
  bind_rows((trigly.crude <- coxph(Surv(ttcvd.deceased, cvd.deceased)~triglycerides_f30870_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE))  %>% 
  bind_rows((ldl.crude <- coxph(Surv(ttcvd.deceased, cvd.deceased)~ldl_direct_f30780_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE)) %>% 
  dplyr::select(estimate, conf.low, conf.high, p.value) %>% mutate(hr=sprintf("%s (%s-%s), %s", round(estimate, 2), round(conf.low, 2), round(conf.high, 2), round(p.value, 3))) %>% dplyr::select(-estimate, -conf.low, -conf.high, -p.value) %>%
  bind_cols(tibble(type=c("Age", "BMI", "HbA1c", "ALT", "Triglycerides", "LDL")),.) %>% 
  write.table(quote = FALSE, sep = ";")

loglik <- 
  rbind(c(as.numeric(anova(cluster.crude)$loglik[2]), NA),
        as.numeric(anova(cluster.crude, age.crude)[2, c("loglik", "Pr(>|Chi|)")]),
        as.numeric(anova(cluster.crude, bmi.crude)[2, c("loglik", "Pr(>|Chi|)")]),
        as.numeric(anova(cluster.crude, hba1c.crude)[2, c("loglik", "Pr(>|Chi|)")]),
        as.numeric(anova(cluster.crude, alt.crude)[2, c("loglik", "Pr(>|Chi|)")]),
        as.numeric(anova(cluster.crude, trigly.crude)[2, c("loglik", "Pr(>|Chi|)")]),
        as.numeric(anova(cluster.crude, ldl.crude)[2, c("loglik", "Pr(>|Chi|)")])) %>% 
  as_tibble() %>% mutate(loglik=sprintf("%s, %s", round(V1, 0), round(V2, 3))) %>% select(loglik)

aic <- 
  c(round(AIC(cluster.crude), 0),
    round(AIC(age.crude), 0),
    round(AIC(bmi.crude), 0),
    round(AIC(hba1c.crude), 0),
    round(AIC(alt.crude), 0),
    round(AIC(trigly.crude), 0),
    round(AIC(ldl.crude), 0))


# CUMULATIVE INCIDENCE CURVE CVD  - FIGURE 5
summary(df$ttcvd.deceased) 
table(df$cvd.deceased.cr <- case_when(df$cvd.deceased==1~1, df$deceased==1~2, TRUE ~ 0), useNA = "ifany")
table(df$cvd.deceased.cr <- as.factor(df$cvd.deceased.cr), useNA = "ifany")
summary(df$cvd.deceased.cr)

cvd.cr.km<- survfit(Surv(ttcvd.deceased, cvd.deceased.cr)~cluster, data = df)
cvd.cr.km
library(ggfortify); library(ggsurvfit)
ggcuminc(cvd.cr.km)+ add_confidence_interval()+scale_ggsurvfit()+
  labs(x="TIME (YEARS)", y="CVD CUMULATIVE INCIDENCE") + 
  scale_color_manual(labels = c("CONTROL","CARDIOMETABOLIC", "LIVER-SPECIFIC"), name="", values = c("gray", "red", "cyan")) +
  scale_fill_manual(labels = c("CONTROL","CARDIOMETABOLIC", "LIVER-SPECIFIC"), name="", values = c("gray", "red", "cyan")) +
  theme(axis.text = element_text(size=13), axis.title = element_text(size=13))

# DIABETES COHORT ####
load("data.RDATA")

# SELECTION CRITERIA#
df <- df %>% 
  filter(body_mass_index_bmi_f21001_0_0>=25) %>% 
  filter(chrlivdis!=1) %>% filter(excl.chrlivdis==0 | excl.chrlivdis==1 & ttexcl.chrlivdis>0) %>%  # Exclude ALL chronic viral hepatitis and other causes of liver disease (registers and self reported)
  filter(diab==0) #	Exclude BASELINE DIAB
nrow(df)

# df <- df %>% dplyr::filter(body_mass_index_bmi_f21001_0_0>=27) # SENSITIVITY 1: BMI≥27
# df <- df %>% dplyr::filter(alcohol.high2==0) # SENSITIVITY 2: excluding excessive alcohol consumption (>50/60 g/d in women/men)

# Cluster analysis 
## variables for clustering: AST, ALT, HDL, HbA1c, Waist circumference, Albumin
df <- df %>% drop_na(age_when_attended_assessment_centre_f21003_0_0, body_mass_index_bmi_f21001_0_0, glycated_haemoglobin_hba1c_f30750_0_0, alanine_aminotransferase_f30620_0_0, triglycerides_f30870_0_0, ldl_direct_f30780_0_0)
df_c <- df %>% dplyr::select(eid, aspartate_aminotransferase_f30650_0_0, alanine_aminotransferase_f30620_0_0, hdl_cholesterol_f30760_0_0, glycated_haemoglobin_hba1c_f30750_0_0, waist_circumference_f48_0_0, albumin_f30600_0_0)

# Scale the data with respect to ABOS values
data_scale = data.frame(eid = df$eid,
                        Age = (df$age_when_attended_assessment_centre_f21003_0_0 -41.739687)/11.6751622,
                        BMI = (df$body_mass_index_bmi_f21001_0_0 -47.181508)/7.8642395,
                        hba1cpc = (df$glycated_haemoglobin_hba1c_f30750_0_0 -6.317347)/1.4289754,
                        TGPUL = (df$alanine_aminotransferase_f30620_0_0-33.266003)/22.1955482,
                        triglymmolL = (df$triglycerides_f30870_0_0 -1.654713)/1.0821998,
                        LDLmmolL = (df$ldl_direct_f30780_0_0 -3.057465)/0.8430835)

# Remove outliers -> those with an absolute value greater than 5
toRemove = unlist(apply(data_scale[,2:7], 2, function(r) which(abs(r) > 5)))
if (length(toRemove) > 0) data_scale = data_scale[-toRemove,]

# Calculate distance to all centers
distMatrix = data.frame(distClust1 = sqrt((data_scale$Age-0.8788154)^2 + (data_scale$BMI-(-0.06122751))^2 + (data_scale$hba1cpc-(-0.22208015))^2 + (data_scale$TGPUL-(-0.1471468))^2 + (data_scale$triglymmolL-(-0.10692422))^2 + (data_scale$LDLmmolL-(-0.8744864))^2),
                        distClust2 = sqrt((data_scale$Age-1.0501193)^2 + (data_scale$BMI-(-0.08665909))^2 + (data_scale$hba1cpc-1.52742507)^2 + (data_scale$TGPUL-0.8440430)^2 + (data_scale$triglymmolL-0.76260098)^2 + (data_scale$LDLmmolL-(-0.9340297))^2),
                        distClust3 = sqrt((data_scale$Age-(-0.7485709))^2 + (data_scale$BMI-1.71898277)^2 + (data_scale$hba1cpc-(-0.57198120))^2 + (data_scale$TGPUL-(-0.3724172))^2 + (data_scale$triglymmolL-(-0.23536631))^2 + (data_scale$LDLmmolL-(-0.2223564))^2),
                        distClust4 = sqrt((data_scale$Age-0.3649040)^2 + (data_scale$BMI-(-0.21381697))^2 + (data_scale$hba1cpc-(-0.36204057))^2 + (data_scale$TGPUL-(-0.2372549))^2 + (data_scale$triglymmolL-(-0.05055755))^2 + (data_scale$LDLmmolL-1.0942392)^2),
                        distClust5 = sqrt((data_scale$Age-(-0.2346594))^2 + (data_scale$BMI-(-0.29011169))^2 + (data_scale$hba1cpc-(-0.08211973))^2 + (data_scale$TGPUL-2.2407195)^2 + (data_scale$triglymmolL-0.09728946)^2 + (data_scale$LDLmmolL-0.3944271)^2),
                        distClust6 = sqrt((data_scale$Age-(-1.0055267))^2 + (data_scale$BMI-(-0.32825905))^2 + (data_scale$hba1cpc-(-0.64196140))^2 + (data_scale$TGPUL-(-0.4625253))^2 + (data_scale$triglymmolL-(-0.33701112))^2 + (data_scale$LDLmmolL-(-0.3765523))^2),
                        eid = data_scale$eid)

# Identify the minimum
distMatrix$min = unlist(apply(distMatrix, 1, function(r) min(r[1:6])))
# And the associated cluster
distMatrix$cluster = unlist(apply(distMatrix, 1, function(r) which(r[1:6] == r[8])))

# Check values
df <- merge(df, distMatrix[,c("eid", "cluster")], by = "eid")


# Supplementary table 4
table(df$alt.high <- case_when(df$sex_f31_0_0=="Male" & df$alanine_aminotransferase_f30620_0_0>42~1, df$sex_f31_0_0=="Female" & df$alanine_aminotransferase_f30620_0_0>30~1, TRUE~0), useNA="ifany")
table(df$ast.high <- case_when(df$sex_f31_0_0=="Male" & df$aspartate_aminotransferase_f30650_0_0>42~1, df$sex_f31_0_0=="Female" & df$aspartate_aminotransferase_f30650_0_0>30~1, TRUE~0), useNA="ifany")
df$prs <- 0.266*df$pnpla3 + 0.274*df$tm6sf2 + 0.065*df$gckr + 0.063*df$mboat7
table(df$prs_cat <- case_when(df$prs<quantile(df$prs, 0.1, na.rm = TRUE)~0, df$prs>quantile(df$prs, 0.9, na.rm = TRUE)~2, TRUE~1), useNA = "ifany")
tab.mcountpct(df$prs_cat, first.cat = TRUE)
quantile(df$prs, 0.1, na.rm = TRUE)
quantile(df$prs, 0.9, na.rm = TRUE)
df$prs5 <- df$prs^(1+0.351*df$hsd)
table(df$diab.inc, df$ttdiab.inc>=0)

table <- 
  rbind(
    "N"=c(nrow(df), nrow(df %>% filter(df$cluster==1)), nrow(df %>% filter(df$cluster==2)), nrow(df %>% filter(df$cluster==3)), nrow(df %>% filter(df$cluster==4)), nrow(df %>% filter(df$cluster==5)), nrow(df %>% filter(df$cluster==6)), ""),
    "Age, years"=c(tab.mean(df$age_when_attended_assessment_centre_f21003_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Women, n (%)"=c(tab.countpct(df$sex_f31_0_0=="Female", df$cluster, all = TRUE, p.value = TRUE)),
    "BMI, kg/m2"=c(tab.mean(df$body_mass_index_bmi_f21001_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "BMI cat"=c(tab.mcountpct(df$bmi_cat, df$cluster, first.cat=TRUE, all = TRUE, p.value = TRUE)),
    "Waist circumference, cm"=c(tab.mean(df$waist_circumference_f48_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Alcohol, high2"= c(tab.countpct(df$alcohol.high2, df$cluster, all = TRUE, p.value = TRUE)),
    "pdff"=c(tab.median(df$pdff, df$cluster, all = TRUE, p.value = TRUE)),
    "pdff NA"=c(tab.countpct(is.na(df$pdff), df$cluster, all = TRUE, p.value = TRUE)),
    "pdff>5.5%, n (%)"=c(tab.countpct(df$pdff.high, df$cluster, all = TRUE, p.value = TRUE)),
    "ct1"=c(tab.median(df$ct1, df$cluster, all = TRUE, p.value = TRUE)),
    "ct1 NA"=c(tab.countpct(is.na(df$ct1), df$cluster, all = TRUE, p.value = TRUE)),
    "pdff>5.5 and ct1>800"=c(tab.countpct(df$pdff.ct1, df$cluster, all = TRUE, p.value = TRUE)),
    "Glucose mg/dL"=c(tab.mean(df$glucose_f30740_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "HbA1c, %"= c(tab.median(df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Total cholesterol, mmol/L"= c(tab.mean(df$cholesterol_f30690_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "LDL cholesterol, mmol/L"= c(tab.mean(df$ldl_direct_f30780_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "HDL cholesterol, mmol/L"= c(tab.mean(df$hdl_cholesterol_f30760_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Triglycerides, mmol/L"= c(tab.median(df$triglycerides_f30870_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "ALT, U/L"= c(tab.median(df$alanine_aminotransferase_f30620_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "AST, U/L"= c(tab.median(df$aspartate_aminotransferase_f30650_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "ALP, U/L"=c(tab.median(df$alkaline_phosphatase_f30610_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "GGT, U/L"=c(tab.median(df$gamma_glutamyltransferase_f30730_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Bilirubin, mg/dL"=c(tab.mean(df$total_bilirubin_f30840_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Albumin, g/dL"=c(tab.mean(df$albumin_f30600_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Platelets, 10e3/uL"=c(tab.mean(df$platelet_count_f30080_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Hypertension, n (%)"=c(tab.countpct(df$ipert, df$cluster, all = TRUE, p.value = TRUE)),
    "Dyslipidemia, n (%)"=c(tab.countpct(df$dyslip, df$cluster, all = TRUE, p.value = TRUE)),
    "PNPLA3 rs738409 C>G (CC/CG/GG), n (%)"= c(tab.mcountpct(df$pnpla3, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "TM6SF2 rs58542926 C>T (CC, CT, TT), n (%)"= c(tab.mcountpct(df$tm6sf2, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "MBOAT7 rs641738 C>T (CC, CT, TT), n (%)"= c(tab.mcountpct(df$mboat7, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "GCKR rs1260326 C>T, n (%)"= c(tab.mcountpct(df$gckr, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "PRS"=c(tab.median(df$prs, df$cluster, all = TRUE, d=3, p.value = TRUE)),
    "PRS CAT"=c(tab.mcountpct(df$prs_cat, df$cluster, all = TRUE, first.cat = TRUE, p.value = TRUE)),
    "DIAB INC, n (%)"=c(tab.countpct(df$diab.inc, df$cluster, all=TRUE, p.value = TRUE, d=3)),
    "Follow-up"=c(tab.median(df$ttdiab.inc, df$cluster, all = TRUE, d=1, p.value = TRUE)))
table
View(table)
write.table(table, quote = FALSE, sep=";")
table(df$cluster)
table.globalp <- 
  rbind(
    "Age, years"=summary(aov(df$age_when_attended_assessment_centre_f21003_0_0 ~ df$cluster))[[1]][[1,5]],
    "Women, n (%)"=chisq.test(df$sex_f31_0_0=="Female", df$cluster)$p.value,
    "BMI, kg/m2"=summary(aov(df$body_mass_index_bmi_f21001_0_0 ~ df$cluster))[[1]][[1,5]],
    "BMI cat"=chisq.test(df$bmi_cat, df$cluster)$p.value,
    "Waist circumference, cm"=summary(aov(df$waist_circumference_f48_0_0 ~ df$cluster))[[1]][[1,5]],
    "Alcohol, high2"= chisq.test(df$alcohol.high2, df$cluster)$p.value,
    "pdff"=summary(aov(df$pdff ~ df$cluster))[[1]][[1,5]],
    "pdff NA"=chisq.test(is.na(df$pdff), df$cluster)$p.value,
    "pdff>5.5%, n (%)"=chisq.test(df$pdff.high, df$cluster)$p.value,
    "ct1"=summary(aov(df$ct1 ~ df$cluster))[[1]][[1,5]],
    "ct1 NA"=chisq.test(is.na(df$ct1), df$cluster)$p.value,
    "pdff>5.5 and ct1>800"=chisq.test(df$pdff.ct1, df$cluster)$p.value,
    "Glucose mg/dL"=summary(aov(df$glucose_f30740_0_0 ~ df$cluster))[[1]][[1,5]],
    "HbA1c, %"= kruskal.test(df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster)$p.value,
    "Total cholesterol, mmol/L"= summary(aov(df$cholesterol_f30690_0_0 ~ df$cluster))[[1]][[1,5]],
    "LDL cholesterol, mmol/L"= summary(aov(df$ldl_direct_f30780_0_0 ~ df$cluster))[[1]][[1,5]],
    "HDL cholesterol, mmol/L"= summary(aov(df$hdl_cholesterol_f30760_0_0 ~ df$cluster))[[1]][[1,5]],
    "Triglycerides, mmol/L"= kruskal.test(df$triglycerides_f30870_0_0, df$cluster)$p.value,
    "ALT, U/L"= kruskal.test(df$alanine_aminotransferase_f30620_0_0, df$cluster)$p.value,
    "AST, U/L"= kruskal.test(df$aspartate_aminotransferase_f30650_0_0, df$cluster)$p.value,
    "ALP, U/L"=kruskal.test(df$alkaline_phosphatase_f30610_0_0, df$cluster)$p.value,
    "GGT, U/L"=kruskal.test(df$gamma_glutamyltransferase_f30730_0_0, df$cluster)$p.value,
    "Bilirubin, mg/dL"=summary(aov(df$total_bilirubin_f30840_0_0 ~ df$cluster))[[1]][[1,5]],
    "Albumin, g/dL"=summary(aov(df$albumin_f30600_0_0 ~ df$cluster))[[1]][[1,5]],
    "Platelets, 10e3/uL"=summary(aov(df$platelet_count_f30080_0_0 ~ df$cluster))[[1]][[1,5]],
    "Hypertension, n (%)"=chisq.test(df$ipert, df$cluster)$p.value,
    "Dyslipidemia, n (%)"=chisq.test(df$dyslip, df$cluster)$p.value,
    "DIAB INC, n (%)"=chisq.test(df$diab.inc, df$cluster)$p.value,
    "Follow-up"=kruskal.test(df$ttcirr.deceased, df$cluster)$p.value)
cbind(table.globalp, p.adjust(c(table.globalp), method = "bonferroni")) 

table.globalp2 <- 
  rbind(
    "PNPLA3 rs738409 C>G (CC/CG/GG), n (%)"= chisq.test(df$pnpla3, df$cluster)$p.value,
    "TM6SF2 rs58542926 C>T (CC, CT, TT), n (%)"= chisq.test(df$tm6sf2, df$cluster)$p.value,
    "MBOAT7 rs641738 C>T (CC, CT, TT), n (%)"= chisq.test(df$mboat7, df$cluster)$p.value,
    "GCKR rs1260326 C>T, n (%)"= chisq.test(df$gckr, df$cluster)$p.value,
    "PRS"=kruskal.test(df$prs, df$cluster)$p.value,
    "PRS CAT"=chisq.test(df$prs_cat, df$cluster)$p.value)
cbind(table.globalp2, p.adjust(c(table.globalp2), method = "bonferroni")) # all significant

# RECODE CLUSTERS
table(df$cluster)
table(df$cluster <- case_when(df$cluster==2~2, df$cluster==5~3, TRUE~1), useNA="ifany") # 2: metabolic; 3: genetic; 1 all the others

table3 <- 
  rbind(
    "N"=c(nrow(df), nrow(df %>% filter(df$cluster==1)), nrow(df %>% filter(df$cluster==2)), nrow(df %>% filter(df$cluster==3)), ""),
    "Age, years"=c(tab.mean(df$age_when_attended_assessment_centre_f21003_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Women, n (%)"=c(tab.countpct(df$sex_f31_0_0=="Female", df$cluster, all = TRUE, p.value = TRUE)),
    "BMI, kg/m2"=c(tab.mean(df$body_mass_index_bmi_f21001_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "BMI cat"=c(tab.mcountpct(df$bmi_cat, df$cluster, first.cat=TRUE, all = TRUE, p.value = TRUE)),
    "Waist circumference, cm"=c(tab.mean(df$waist_circumference_f48_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Alcohol, high2"= c(tab.countpct(df$alcohol.high2, df$cluster, all = TRUE, p.value = TRUE)),
    "pdff"=c(tab.median(df$pdff, df$cluster, all = TRUE, p.value = TRUE)),
    "pdff NA"=c(tab.countpct(is.na(df$pdff), df$cluster, all = TRUE, p.value = TRUE)),
    "pdff>5.5%, n (%)"=c(tab.countpct(df$pdff.high, df$cluster, all = TRUE, p.value = TRUE)),
    "ct1"=c(tab.median(df$ct1, df$cluster, all = TRUE, p.value = TRUE)),
    "ct1 NA"=c(tab.countpct(is.na(df$ct1), df$cluster, all = TRUE, p.value = TRUE)),
    "pdff>5.5 and ct1>800"=c(tab.countpct(df$pdff.ct1, df$cluster, all = TRUE, p.value = TRUE)),
    "Glucose mg/dL"=c(tab.mean(df$glucose_f30740_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "HbA1c, %"= c(tab.median(df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Total cholesterol, mmol/L"= c(tab.mean(df$cholesterol_f30690_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "LDL cholesterol, mmol/L"= c(tab.mean(df$ldl_direct_f30780_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "HDL cholesterol, mmol/L"= c(tab.mean(df$hdl_cholesterol_f30760_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Triglycerides, mmol/L"= c(tab.median(df$triglycerides_f30870_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "ALT, U/L"= c(tab.median(df$alanine_aminotransferase_f30620_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "AST, U/L"= c(tab.median(df$aspartate_aminotransferase_f30650_0_0, df$cluster, all = TRUE)),
    "ALP, U/L"=c(tab.median(df$alkaline_phosphatase_f30610_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "GGT, U/L"=c(tab.median(df$gamma_glutamyltransferase_f30730_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Bilirubin, mg/dL"=c(tab.mean(df$total_bilirubin_f30840_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Albumin, g/dL"=c(tab.mean(df$albumin_f30600_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Platelets, 10e3/uL"=c(tab.mean(df$platelet_count_f30080_0_0, df$cluster, all = TRUE, p.value = TRUE)),
    "Hypertension, n (%)"=c(tab.countpct(df$ipert, df$cluster, all = TRUE, p.value = TRUE)),
    "Dyslipidemia, n (%)"=c(tab.countpct(df$dyslip, df$cluster, all = TRUE, p.value = TRUE)),
    "PNPLA3 rs738409 C>G (CC/CG/GG), n (%)"= c(tab.mcountpct(df$pnpla3, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "TM6SF2 rs58542926 C>T (CC, CT, TT), n (%)"= c(tab.mcountpct(df$tm6sf2, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "MBOAT7 rs641738 C>T (CC, CT, TT), n (%)"= c(tab.mcountpct(df$mboat7, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "GCKR rs1260326 C>T, n (%)"= c(tab.mcountpct(df$gckr, df$cluster, first.cat = TRUE, p.value = TRUE, all=TRUE)),
    "PRS"=c(tab.median(df$prs, df$cluster, all = TRUE, d=3, p.value = TRUE)),
    "PRS CAT"=c(tab.mcountpct(df$prs_cat, df$cluster, all = TRUE, first.cat = TRUE, p.value = TRUE)),
    "DIAB INC, n (%)"=c(tab.countpct(df$diab.inc, df$cluster, all=TRUE, p.value = TRUE, d=3)),
    "Follow-up"=c(tab.median(df$ttdiab.inc, df$cluster, all = TRUE, d=1, p.value = TRUE)))
table3[,2]
write.table(table3, quote = FALSE, sep=";")

# PAIRWISE COMPARISONS
library(fifer)

table.p <- 
  rbind(
    "Age, years"=c(p(pairwise.wilcox.test( df$age_when_attended_assessment_centre_f21003_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$age_when_attended_assessment_centre_f21003_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$age_when_attended_assessment_centre_f21003_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Women, n (%)"=c(p(chisq.post.hoc(table(df$cluster, df$sex_f31_0_0=="Female"), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$sex_f31_0_0=="Female"), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$sex_f31_0_0=="Female"), control = "bonferroni")[3,3])),
    "BMI, kg/m2"=c(p(pairwise.wilcox.test( df$body_mass_index_bmi_f21001_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$body_mass_index_bmi_f21001_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$body_mass_index_bmi_f21001_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "BMI cat"=c(p(p.adjust(chisq.test(df$bmi_cat[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$bmi_cat[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$bmi_cat[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "Waist circumference, cm"=c(p(pairwise.wilcox.test( df$waist_circumference_f48_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$waist_circumference_f48_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$waist_circumference_f48_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Alcohol high2"=c(p(chisq.post.hoc(table(df$cluster, df$alcohol.high), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$alcohol.high2), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$alcohol.high2), control = "bonferroni")[3,3])),
    "pdff"=c(p(pairwise.wilcox.test( df$pdff, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$pdff, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$pdff, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "pdff NA"=c(p(chisq.post.hoc(table(df$cluster, is.na(df$pdff)), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, is.na(df$pdff)), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, is.na(df$pdff)), control = "bonferroni")[3,3])),
    "pdff>5.5%, n (%)"=c(p(chisq.post.hoc(table(df$cluster, df$pdff.high), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$pdff.high), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$pdff.high), control = "bonferroni")[3,3])),
    "ct1"=c(p(pairwise.wilcox.test( df$ct1, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$ct1, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$ct1, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "ct1 NA"=c(p(chisq.post.hoc(table(df$cluster, is.na(df$ct1)), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, is.na(df$ct1)), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, is.na(df$ct1)), control = "bonferroni")[3,3])),
    "pdff>5.5 and ct1>800"=c(p(chisq.post.hoc(table(df$cluster, df$pdff.ct1), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$pdff.ct1), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$pdff.ct1), control = "bonferroni")[3,3])),
    "Glucose mg/dL"=c(p(pairwise.wilcox.test( df$glucose_f30740_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$glucose_f30740_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$glucose_f30740_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "HbA1c, %"= c(p(pairwise.wilcox.test( df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$glycated_haemoglobin_hba1c_f30750_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Total cholesterol, mmol/L"= c(p(pairwise.wilcox.test( df$cholesterol_f30690_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$cholesterol_f30690_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$cholesterol_f30690_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "LDL cholesterol, mmol/L"= c(p(pairwise.wilcox.test( df$ldl_direct_f30780_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$ldl_direct_f30780_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$ldl_direct_f30780_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "HDL cholesterol, mmol/L"= c(p(pairwise.wilcox.test( df$hdl_cholesterol_f30760_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$hdl_cholesterol_f30760_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$hdl_cholesterol_f30760_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Triglycerides, mmol/L"= c(p(pairwise.wilcox.test( df$triglycerides_f30870_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$triglycerides_f30870_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$triglycerides_f30870_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "ALT, U/L"= c(p(pairwise.wilcox.test( df$alanine_aminotransferase_f30620_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$alanine_aminotransferase_f30620_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$alanine_aminotransferase_f30620_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "AST, U/L"= c(p(pairwise.wilcox.test(df$aspartate_aminotransferase_f30650_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$aspartate_aminotransferase_f30650_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test(df$aspartate_aminotransferase_f30650_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "ALP, U/L"=c(p(pairwise.wilcox.test( df$alkaline_phosphatase_f30610_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$alkaline_phosphatase_f30610_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$alkaline_phosphatase_f30610_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "GGT, U/L"=c(p(pairwise.wilcox.test( df$gamma_glutamyltransferase_f30730_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$gamma_glutamyltransferase_f30730_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$gamma_glutamyltransferase_f30730_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Bilirubin, mg/dL"=c(p(pairwise.wilcox.test( df$total_bilirubin_f30840_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$total_bilirubin_f30840_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$total_bilirubin_f30840_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Albumin, g/dL"=c(p(pairwise.wilcox.test( df$albumin_f30600_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$albumin_f30600_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$albumin_f30600_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Platelets, 10e3/uL"=c(p(pairwise.wilcox.test( df$platelet_count_f30080_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$platelet_count_f30080_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$platelet_count_f30080_0_0, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "Hypertension, n (%)"=c(p(chisq.post.hoc(table(df$cluster, df$ipert), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$ipert), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$ipert), control = "bonferroni")[3,3])),
    "Dyslipidemia, n (%)"=c(p(chisq.post.hoc(table(df$cluster, df$dyslip), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$dyslip), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$dyslip), control = "bonferroni")[3,3])),
    "PNPLA3 rs738409 C>G (CC/CG/GG), n (%)"= c(p(p.adjust(chisq.test(df$pnpla3[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$pnpla3[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$pnpla3[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "TM6SF2 rs58542926 C>T (CC, CT, TT), n (%)"= c(p(p.adjust(chisq.test(df$tm6sf2[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$tm6sf2[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$tm6sf2[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "MBOAT7 rs641738 C>T (CC, CT, TT), n (%)"= c(p(p.adjust(chisq.test(df$mboat7[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$mboat7[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$mboat7[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "GCKR rs1260326 C>T, n (%)"= c(p(p.adjust(chisq.test(df$gckr[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$gckr[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$gckr[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "PRS"=c(p(pairwise.wilcox.test( df$prs, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$prs, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test( df$prs, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])),
    "PRS CAT"= c(p(p.adjust(chisq.test(df$prs_cat[df$cluster!=3], df$cluster[df$cluster!=3])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$prs_cat[df$cluster!=2], df$cluster[df$cluster!=2])$p.value, method = "bonferroni", n=3)), p(p.adjust(chisq.test(df$prs_cat[df$cluster!=1], df$cluster[df$cluster!=1])$p.value, method = "bonferroni", n=3))),
    "DIAB INC, n (%)"= c(p(chisq.post.hoc(table(df$cluster, df$diab.inc), control = "bonferroni")[1,3]), p(chisq.post.hoc(table(df$cluster, df$diab.inc), control = "bonferroni")[2,3]), p(chisq.post.hoc(table(df$cluster, df$diab.inc), control = "bonferroni")[3,3])),
    "Follow-up"=c(p(pairwise.wilcox.test(df$ttdiab.inc, df$cluster, p.adjust.method = "bonferroni")$p.value[1,1]), p(pairwise.wilcox.test( df$ttdiab.inc, df$cluster, p.adjust.method = "bonferroni")$p.value[2,1]), p(pairwise.wilcox.test(df$ttdiab.inc, df$cluster, p.adjust.method = "bonferroni")$p.value[2,2])))
table.p <- rbind("N"=c("", "", ""), table.p)
table.p
write.table(table.p, quote = FALSE, sep=";")
# table total
dim(table)
tab.tot <- cbind(table, table3[,2], table.p)
colnames(tab.tot) <- c(colnames(table), "CTRL", "2 vs CTRL", "5 vs CTRL", "2 vs 5")
tab.tot
write.table(tab.tot, quote = FALSE, sep = ";")

# COX regressions
cox.zph(coxph(Surv(ttdiab.inc, diab.inc)~cluster, data = df))
coxph(Surv(ttdiab.inc, diab.inc)~cluster, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% 
  bind_rows(coxph(Surv(ttdiab.inc, diab.inc)~cluster+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1)) %>% 
  dplyr::select(estimate, conf.low, conf.high, p.value) %>% mutate(across(everything(), ~round(.x, 2))) %>% knitr::kable()

cox.zph(coxph(Surv(ttdiab.inc, diab.inc)~as.factor(cluster), data = df))
(cluster.crude <- coxph(Surv(ttdiab.inc, diab.inc)~as.factor(cluster), data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% 
  bind_rows(coxph(Surv(ttdiab.inc, diab.inc)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  dplyr::select(term, estimate, conf.low, conf.high, p.value) %>% mutate(hr=sprintf("%s (%s-%s), %s", round(estimate, 2), round(conf.low, 2), round(conf.high, 2), round(p.value, 3))) %>% dplyr::select(-estimate, -conf.low, -conf.high, -p.value) %>%
  bind_cols(tibble(type=c("Uni", "Uni", "Adj", "Adj"))) %>% 
  pivot_wider(names_from = term, values_from = hr) %>% 
  write.table(quote = FALSE, sep = ";")

# Supplementary table 13 and data for Supplementary Figure 6
bind_rows(
  coxph(Surv(ttdiab.inc, diab.inc)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2),
  coxph(Surv(ttdiab.inc, diab.inc)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day+alanine_aminotransferase_f30620_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2),
  coxph(Surv(ttdiab.inc, diab.inc)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day+glycated_haemoglobin_hba1c_f30750_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2),
  coxph(Surv(ttdiab.inc, diab.inc)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day+body_mass_index_bmi_f21001_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2),
  coxph(Surv(ttdiab.inc, diab.inc)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day+triglycerides_f30870_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2),
  coxph(Surv(ttdiab.inc, diab.inc)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0+sex_f31_0_0+alcohol_g_day+ldl_direct_f30780_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  dplyr::select(term, estimate, conf.low, conf.high, p.value) %>% mutate(hr=sprintf("%s (%s-%s), %s", round(estimate, 2), round(conf.low, 2), round(conf.high, 2), round(p.value, 3))) %>% dplyr::select(-estimate, -conf.low, -conf.high, -p.value) %>%
  bind_cols(tibble(type=c( "adj", "adj","adj+ALT", "adj+ALT", "adj+HbA1c", "adj+HbA1c", "adj+BMI", "adj+BMI", "adj+trigly", "adj+trigly", "adj+LDL", "adj+LDL"))) %>% 
  pivot_wider(names_from = term, values_from = hr) %>% 
  write.table(quote = FALSE, sep = ";")

(cluster.crude <- coxph(Surv(ttdiab.inc, diab.inc)~as.factor(cluster), data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% 
  bind_rows(coxph(Surv(ttdiab.inc, diab.inc)~as.factor(cluster)+age_when_attended_assessment_centre_f21003_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  bind_rows(coxph(Surv(ttdiab.inc, diab.inc)~as.factor(cluster)+body_mass_index_bmi_f21001_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  bind_rows(coxph(Surv(ttdiab.inc, diab.inc)~as.factor(cluster)+glycated_haemoglobin_hba1c_f30750_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>%
  bind_rows(coxph(Surv(ttdiab.inc, diab.inc)~as.factor(cluster)+alanine_aminotransferase_f30620_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  bind_rows(coxph(Surv(ttdiab.inc, diab.inc)~as.factor(cluster)+triglycerides_f30870_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  bind_rows(coxph(Surv(ttdiab.inc, diab.inc)~as.factor(cluster)+ldl_direct_f30780_0_0, data = df) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% slice(1:2)) %>% 
  dplyr::select(term, estimate, conf.low, conf.high, p.value) %>% mutate(hr=sprintf("%s (%s-%s), %s", round(estimate, 2), round(conf.low, 2), round(conf.high, 2), round(p.value, 3))) %>% dplyr::select(-estimate, -conf.low, -conf.high, -p.value) %>%
  bind_cols(tibble(type=c("Cluster", "Cluster", "Cluster+Age", "Cluster+Age", "Cluster+BMI", "Cluster+BMI", "Cluster+HbA1c", "Cluster+HbA1c", "Cluster+ALT", "Cluster+ALT", "Cluster+Triglycerides", "Cluster+Triglycerides", "Cluster+LDL", "Cluster+LDL"))) %>% 
  pivot_wider(names_from = term, values_from = hr) %>% 
  write.table(quote = FALSE, sep = ";")

(age.crude <- coxph(Surv(ttdiab.inc, diab.inc)~age_when_attended_assessment_centre_f21003_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE) %>% 
  bind_rows((bmi.crude <- coxph(Surv(ttdiab.inc, diab.inc)~body_mass_index_bmi_f21001_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE)) %>% 
  bind_rows((hba1c.crude <- coxph(Surv(ttdiab.inc, diab.inc)~glycated_haemoglobin_hba1c_f30750_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE))  %>%
  bind_rows((alt.crude <- coxph(Surv(ttdiab.inc, diab.inc)~alanine_aminotransferase_f30620_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE))  %>% 
  bind_rows((trigly.crude <- coxph(Surv(ttdiab.inc, diab.inc)~triglycerides_f30870_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE))  %>% 
  bind_rows((ldl.crude <- coxph(Surv(ttdiab.inc, diab.inc)~ldl_direct_f30780_0_0, data = df)) %>% tidy(exponentiate=TRUE, conf.int=TRUE)) %>% 
  dplyr::select(estimate, conf.low, conf.high, p.value) %>% mutate(hr=sprintf("%s (%s-%s), %s", round(estimate, 2), round(conf.low, 2), round(conf.high, 2), round(p.value, 3))) %>% dplyr::select(-estimate, -conf.low, -conf.high, -p.value) %>%
  bind_cols(tibble(type=c("Age", "BMI", "HbA1c", "ALT", "Triglycerides", "LDL")),.) %>% 
  write.table(quote = FALSE, sep = ";")

loglik <- 
  rbind(c(as.numeric(anova(cluster.crude)$loglik[2]), NA),
        as.numeric(anova(cluster.crude, age.crude)[2, c("loglik", "Pr(>|Chi|)")]),
        as.numeric(anova(cluster.crude, bmi.crude)[2, c("loglik", "Pr(>|Chi|)")]),
        as.numeric(anova(cluster.crude, hba1c.crude)[2, c("loglik", "Pr(>|Chi|)")]),
        as.numeric(anova(cluster.crude, alt.crude)[2, c("loglik", "Pr(>|Chi|)")]),
        as.numeric(anova(cluster.crude, trigly.crude)[2, c("loglik", "Pr(>|Chi|)")]),
        as.numeric(anova(cluster.crude, ldl.crude)[2, c("loglik", "Pr(>|Chi|)")])) %>% 
  as_tibble() %>% mutate(loglik=sprintf("%s, %s", round(V1, 0), round(V2, 3))) %>% select(loglik)

aic <- 
  c(round(AIC(cluster.crude), 0),
    round(AIC(age.crude), 0),
    round(AIC(bmi.crude), 0),
    round(AIC(hba1c.crude), 0),
    round(AIC(alt.crude), 0),
    round(AIC(trigly.crude), 0),
    round(AIC(ldl.crude), 0))

# CUMULATIVE INCIDENCE CURVE DIAB - FIGURE 5
summary(df$ttdiab.inc) 
table(df$diab.inc.cr <- case_when(df$diab.inc==1~1, df$deceased==1~2, TRUE ~ 0), useNA = "ifany")
table(df$diab.inc.cr <- as.factor(df$diab.inc.cr), useNA = "ifany")
summary(df$diab.inc.cr)

diab.cr.km<- survfit(Surv(ttdiab.inc, diab.inc.cr)~cluster, data = df)
diab.cr.km
library(ggfortify); library(ggsurvfit)
ggcuminc(diab.cr.km)+ add_confidence_interval()+scale_ggsurvfit()+
  labs(x="TIME (YEARS)", y="TYPE 2 DIABETES CUMULATIVE INCIDENCE") + 
  scale_color_manual(labels = c("CONTROL","CARDIOMETABOLIC", "LIVER-SPECIFIC"), name="", values = c("gray", "red", "cyan")) +
  scale_fill_manual(labels = c("CONTROL","CARDIOMETABOLIC", "LIVER-SPECIFIC"), name="", values = c("gray", "red", "cyan")) +
  theme(axis.text = element_text(size=13), axis.title = element_text(size=13))
